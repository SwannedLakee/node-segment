"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const worker_threads_1 = require("worker_threads");
const lineByLine = require("n-readlines");
const project_config_1 = require("../project.config");
const path = require("upath2");
const index_1 = require("segment-dict/lib/loader/segment/index");
const uni_string_1 = require("uni-string");
const util_1 = require("@novel-segment/util");
const transliteration_1 = require("transliteration");
const fs = require("fs-extra");
const cjk_conv_1 = require("cjk-conv");
const fast_glob_1 = require("fast-glob");
const util_2 = require("segment-dict/script/util");
const array_hyper_unique_1 = require("array-hyper-unique");
const line_1 = require("segment-dict/lib/loader/line");
const debug_color2_1 = require("debug-color2");
const greedy_1 = require("cjk-conv/lib/zh/table/greedy");
const pinyin = require("pinyin");
const table_1 = require("cjk-conv/lib/zh/table");
const diff_staged_1 = require("@git-lazy/diff-staged");
const match_1 = require("@git-lazy/util/util/match");
let CWD = path.join(project_config_1.default.temp_root);
var EnumC1;
(function (EnumC1) {
    EnumC1["char"] = "char";
    EnumC1["other"] = "other";
    EnumC1["eng"] = "eng";
})(EnumC1 || (EnumC1 = {}));
const CWD_SAVETO = path.join(CWD, 'cache');
if (0 && (!fs.pathExistsSync(path.join(CWD, 'stringify.txt')) || !match_1.matchGlob(diff_staged_1.gitDiffStagedFile(CWD), [
    'cache.db.info.json'
]).length)) {
    process.exit();
}
if (worker_threads_1.isMainThread) {
    log("This is the main thread", worker_threads_1.threadId);
    let workerOptions = {
        workerData: {
            time: new Date,
        },
    };
    let w1 = new worker_threads_1.Worker(__filename, workerOptions);
    //let w2 = new Worker(__filename, workerOptions);
    //	const subChannel = new MessageChannel();
    //
    //	w2.postMessage({
    //		hereIsYourPort: subChannel.port1
    //	}, [subChannel.port1]);
    //	w1.postMessage({
    //		hereIsYourPort: subChannel.port2
    //	}, [subChannel.port2]);
    let timeDiff;
    fs.removeSync(CWD_SAVETO);
    w1.on('message', (msg) => {
        timeDiff = msg.timeDiff;
        //console.dir(msg);
        log(msg.index, msg.list.length);
        let cache = {
            char: [],
            other: [],
            eng: [],
        };
        {
            let i = 'a'.codePointAt(0);
            let j = 'z'.codePointAt(0);
            while (i <= j) {
                cache[String.fromCodePoint(i)] = [];
                i++;
            }
        }
        cache = msg.list.reduce(function (cache, cur) {
            // @ts-ignore
            let { c1, line } = cur;
            cache[c1] = cache[c1] || [];
            cache[c1].push(Buffer.from(line).toString());
            return cache;
        }, cache);
        Object.entries(cache).forEach(async function ([c1, ls]) {
            if (!/^[a-z0-9]$/i.test(c1)) {
                c1 = '0/' + c1;
            }
            let file = path.join(CWD_SAVETO, c1 + '.txt');
            fs.ensureFileSync(file);
            if (!ls.length) {
                return;
            }
            return fs.appendFileSync(file, ls.join('\n') + '\n');
        });
        //fs.appendFile()
    });
    w1.on('error', e => debug_color2_1.console.error(debug_color2_1.console));
    w1.on('exit', (code) => {
        let bool = true;
        try {
            let i = timeDiff.getTime() - workerOptions.workerData.time.getTime();
            log(i, timeDiff);
        }
        catch (e) {
            bool = false;
        }
        if (bool) {
            let ls = fast_glob_1.sync([
                '**/*.txt'
            ], {
                cwd: CWD_SAVETO,
                absolute: true,
            }).sort();
            let file2 = path.join(CWD, 'stringify.sorted.txt');
            fs.ensureFileSync(file2);
            fs.truncateSync(file2);
            let i2 = ls.reduce((a, file) => {
                log('[start]', path.relative(CWD_SAVETO, file));
                const liner = new lineByLine(file);
                let line;
                let index = 0;
                let list = [];
                while (line = liner.next()) {
                    let s = line.toString();
                    let data = index_1.parseLine(s);
                    let [w, p, f] = data;
                    let cur = {
                        // @ts-ignore
                        data,
                        line: s,
                        index: index++,
                        c1: "other" /* other */,
                        line_type: util_2.chkLineType(s),
                        cjk_id: util_1.getCjkName(w),
                    };
                    list.push(cur);
                    a++;
                }
                list = SortList(list);
                let out_list = list.map(v => v.line);
                out_list = array_hyper_unique_1.array_unique(out_list);
                let out_data = line_1.serialize(out_list);
                fs.outputFileSync(file, out_data + "\n\n");
                fs.appendFileSync(file2, out_data + "\n");
                log('[done]', path.relative(CWD_SAVETO, file));
                return a;
            }, 0);
            log(i2);
        }
        if (code != 0) {
            debug_color2_1.console.error(new Error(`Worker stopped with exit code ${code}`));
        }
        else {
            log(`Worker stopped`);
        }
    });
}
else {
    //	parentPort.once('message', (value) => {
    //		value.hereIsYourPort.postMessage('hello');
    //		value.hereIsYourPort.on('message', msg => {
    //			console.log(`thread ${threadId}: receive ${msg}`);
    //		});
    //	});
    //the worker's code
    debug_color2_1.console.dir(worker_threads_1.workerData, {
        colors: true,
    });
    //	log(workerData.re.test(' '));
    let file = path.join(CWD, 'stringify.txt');
    const liner = new lineByLine(file);
    let line;
    let lineNumber = 0;
    let count = 0;
    let c1_old;
    let list = [];
    while (line = liner.next()) {
        //console.log('Line ' + lineNumber + ': ' + line.toString('ascii'));
        let index = lineNumber++;
        let data = index_1.parseLine(line.toString());
        let cur = {
            data,
            line,
            index,
            c1: "other" /* other */,
        };
        let [w, p, f] = cur.data;
        let len = uni_string_1.default.size(w);
        let c1_now;
        if (len > 1) {
            c1_now = getCid(w);
            if (!c1_now) {
                debug_color2_1.console.log(c1_now, w);
                throw new Error(`${w}, ${c1_now}`);
            }
        }
        else if (len === 1) {
            c1_now = "char" /* char */;
        }
        else {
            c1_now = "other" /* other */;
        }
        cur.c1 = c1_now;
        if (count >= 10000) {
            worker_threads_1.parentPort.postMessage({
                index,
                list,
            });
            list = [];
            count = 0;
        }
        list.push(cur);
        c1_old = c1_now;
        count++;
    }
    log('end of line reached', lineNumber);
    worker_threads_1.workerData.count = lineNumber;
    worker_threads_1.parentPort.postMessage({
        timeDiff: new Date,
        index: lineNumber,
        list,
    });
}
function log(...argv) {
    debug_color2_1.console.log(`[thread:${worker_threads_1.threadId}]`, ...argv);
}
function getCid(w) {
    w = uni_string_1.default.slice(w, 0, 1).toLocaleLowerCase();
    if (/^[a-z0-9]$/i.test(w)) {
        return "eng" /* eng */;
    }
    let s = util_1.getCjkName(w);
    let r = transliteration_1.slugify(s);
    if (!r) {
        try {
            r = transliteration_1.slugify(pinyin(s)[0][0]);
        }
        catch (e) {
        }
    }
    if (!r) {
        try {
            r = transliteration_1.slugify(pinyin(w)[0][0]);
        }
        catch (e) {
        }
    }
    if (!r) {
        r = transliteration_1.slugify(greedy_1.greedyTableReplace(s));
    }
    if (!r) {
        let arr = table_1.default.auto(s, {
            safe: false,
            greedyTable: 2,
        });
        if (arr.length) {
            r = transliteration_1.slugify(arr[1] || arr[0]);
        }
    }
    if (!r) {
        let arr = table_1.default.auto(w, {
            safe: false,
            greedyTable: 2,
        });
        if (arr.length) {
            r = transliteration_1.slugify(arr[1] || arr[0]);
        }
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zhs(s));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zht(s));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zhs(w));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zht(w));
    }
    if (!r) {
        r = transliteration_1.slugify(w);
    }
    if (!r) {
        r = w;
    }
    let r2 = uni_string_1.default.slice(r, 0, 1);
    if (!/^[a-z0-9]$/i.test(r2)) {
        r2 = "other" /* other */;
    }
    return r2.toLocaleLowerCase();
}
function SortList(ls) {
    // @ts-ignore
    return ls.sort(function (a, b) {
        if (a.line_type == util_2.EnumLineType.COMMENT_TAG
            || b.line_type == util_2.EnumLineType.COMMENT_TAG) {
            return (a.index - b.index);
        }
        else if (a.line_type == util_2.EnumLineType.COMMENT
            || b.line_type == util_2.EnumLineType.COMMENT) {
            return (a.index - b.index);
        }
        let ret = util_1.zhDictCompare(a.cjk_id, b.cjk_id)
            || (a.index - b.index)
            || 0;
        return ret;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydC1zdHJpbmdpZnktY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzb3J0LXN0cmluZ2lmeS1jYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQVF3QjtBQUN4QiwwQ0FBMkM7QUFDM0Msc0RBQThDO0FBQzlDLCtCQUErQjtBQUMvQixpRUFBK0g7QUFDL0gsMkNBQWlDO0FBQ2pDLDhDQUFnRTtBQUNoRSxxREFBNEU7QUFDNUUsK0JBQWdDO0FBRWhDLHVDQUE0QztBQUU1Qyx5Q0FBaUQ7QUFDakQsbURBQXdGO0FBQ3hGLDJEQUFrRDtBQUNsRCx1REFBeUQ7QUFDekQsK0NBQXVEO0FBQ3ZELHlEQUFrRTtBQUNsRSxpQ0FBa0M7QUFDbEMsaURBQTZDO0FBQzdDLHVEQUEwRDtBQUMxRCxxREFBc0Q7QUFFdEQsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyx3QkFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRTdDLElBQVcsTUFLVjtBQUxELFdBQVcsTUFBTTtJQUVoQix1QkFBYSxDQUFBO0lBQ2IseUJBQWUsQ0FBQTtJQUNmLHFCQUFXLENBQUE7QUFDWixDQUFDLEVBTFUsTUFBTSxLQUFOLE1BQU0sUUFLaEI7QUFFRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUUzQyxJQUFJLENBQUMsSUFBSSxDQUFDLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQVMsQ0FBQywrQkFBaUIsQ0FBQyxHQUFHLENBQUMsRUFBRTtJQUNuRyxvQkFBb0I7Q0FDcEIsQ0FBQyxDQUFDLE1BQU0sQ0FBQyxFQUNWO0lBQ0MsT0FBTyxDQUFDLElBQUksRUFBRSxDQUFDO0NBQ2Y7QUFFRCxJQUFJLDZCQUFZLEVBQ2hCO0lBQ0MsR0FBRyxDQUFDLHlCQUF5QixF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QyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQztJQUVoQyxJQUFJLENBQUMsYUFBYSxDQUFDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFDM0I7UUFDQyxFQUFFLHNCQUFlLENBQUM7S0FDbEI7SUFFRCxPQUFPLEVBQUUsQ0FBQyxpQkFBaUIsRUFBRSxDQUFBO0FBQzlCLENBQUM7QUFFRCxTQUFTLFFBQVEsQ0FBd0IsRUFBTztJQUUvQyxhQUFhO0lBQ2IsT0FBTyxFQUFFLENBQUMsSUFBSSxDQUFDLFVBQVUsQ0FBb0IsRUFBRSxDQUFvQjtRQUVsRSxJQUNDLENBQUMsQ0FBQyxTQUFTLElBQUksbUJBQVksQ0FBQyxXQUFXO2VBQ3BDLENBQUMsQ0FBQyxTQUFTLElBQUksbUJBQVksQ0FBQyxXQUFXLEVBRTNDO1lBQ0MsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzNCO2FBQ0ksSUFDSixDQUFDLENBQUMsU0FBUyxJQUFJLG1CQUFZLENBQUMsT0FBTztlQUNoQyxDQUFDLENBQUMsU0FBUyxJQUFJLG1CQUFZLENBQUMsT0FBTyxFQUV2QztZQUNDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMzQjtRQUVELElBQUksR0FBRyxHQUFHLG9CQUFhLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDO2VBQ3ZDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2VBQ25CLENBQUMsQ0FDSjtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ1osQ0FBQyxDQUFDLENBQUE7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0V29ya2VyLFxuXHRpc01haW5UaHJlYWQsXG5cdHBhcmVudFBvcnQsXG5cdHdvcmtlckRhdGEsXG5cdHRocmVhZElkLFxuXHRNZXNzYWdlQ2hhbm5lbCxcblx0TWVzc2FnZVBvcnQsXG59IGZyb20gJ3dvcmtlcl90aHJlYWRzJztcbmltcG9ydCBsaW5lQnlMaW5lID0gcmVxdWlyZSgnbi1yZWFkbGluZXMnKTtcbmltcG9ydCBQcm9qZWN0Q29uZmlnIGZyb20gJy4uL3Byb2plY3QuY29uZmlnJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInVwYXRoMlwiO1xuaW1wb3J0IHsgSURpY3RSb3csIHBhcnNlTGluZSBhcyBwYXJzZUxpbmVTZWdtZW50LCBzZXJpYWxpemUgYXMgc2VyaWFsaXplU2VnbWVudCB9IGZyb20gJ3NlZ21lbnQtZGljdC9saWIvbG9hZGVyL3NlZ21lbnQvaW5kZXgnO1xuaW1wb3J0IFVTdHJpbmcgZnJvbSAndW5pLXN0cmluZyc7XG5pbXBvcnQgeyBnZXRDamtOYW1lLCB6aERpY3RDb21wYXJlIH0gZnJvbSAnQG5vdmVsLXNlZ21lbnQvdXRpbCc7XG5pbXBvcnQgeyB0cmFuc2xpdGVyYXRlIGFzIHRyLCBzbHVnaWZ5IGFzIHNsdWdpZnlUciB9IGZyb20gJ3RyYW5zbGl0ZXJhdGlvbic7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCB7IGNqazJ6aHMsIGNqazJ6aHQgfSBmcm9tICdjamstY29udic7XG5pbXBvcnQgU3RyVXRpbCA9IHJlcXVpcmUoJ3N0ci11dGlsJyk7XG5pbXBvcnQgeyBzeW5jIGFzIEZhc3RHbG9iU3luYyB9IGZyb20gJ2Zhc3QtZ2xvYic7XG5pbXBvcnQgeyBjaGtMaW5lVHlwZSwgRW51bUxpbmVUeXBlLCBJTG9hZERpY3RGaWxlUm93MiB9IGZyb20gJ3NlZ21lbnQtZGljdC9zY3JpcHQvdXRpbCc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUgfSBmcm9tICdhcnJheS1oeXBlci11bmlxdWUnO1xuaW1wb3J0IHsgc2VyaWFsaXplIH0gZnJvbSAnc2VnbWVudC1kaWN0L2xpYi9sb2FkZXIvbGluZSc7XG5pbXBvcnQgeyBjb25zb2xlLCBjaGFsa0J5Q29uc29sZSB9IGZyb20gJ2RlYnVnLWNvbG9yMic7XG5pbXBvcnQgeyBncmVlZHlUYWJsZVJlcGxhY2UgfSBmcm9tICdjamstY29udi9saWIvemgvdGFibGUvZ3JlZWR5JztcbmltcG9ydCBwaW55aW4gPSByZXF1aXJlKFwicGlueWluXCIpO1xuaW1wb3J0IGxpYlRhYmxlIGZyb20gJ2Nqay1jb252L2xpYi96aC90YWJsZSc7XG5pbXBvcnQgeyBnaXREaWZmU3RhZ2VkRmlsZSB9IGZyb20gJ0BnaXQtbGF6eS9kaWZmLXN0YWdlZCc7XG5pbXBvcnQgeyBtYXRjaEdsb2IgfSBmcm9tICdAZ2l0LWxhenkvdXRpbC91dGlsL21hdGNoJztcblxubGV0IENXRCA9IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLnRlbXBfcm9vdCk7XG5cbmNvbnN0IGVudW0gRW51bUMxXG57XG5cdGNoYXIgPSAnY2hhcicsXG5cdG90aGVyID0gJ290aGVyJyxcblx0ZW5nID0gJ2VuZycsXG59XG5cbmNvbnN0IENXRF9TQVZFVE8gPSBwYXRoLmpvaW4oQ1dELCAnY2FjaGUnKTtcblxuaWYgKDAgJiYgKCFmcy5wYXRoRXhpc3RzU3luYyhwYXRoLmpvaW4oQ1dELCAnc3RyaW5naWZ5LnR4dCcpKSB8fCAhbWF0Y2hHbG9iKGdpdERpZmZTdGFnZWRGaWxlKENXRCksIFtcblx0J2NhY2hlLmRiLmluZm8uanNvbidcbl0pLmxlbmd0aCkpXG57XG5cdHByb2Nlc3MuZXhpdCgpO1xufVxuXG5pZiAoaXNNYWluVGhyZWFkKVxue1xuXHRsb2coXCJUaGlzIGlzIHRoZSBtYWluIHRocmVhZFwiLCB0aHJlYWRJZCk7XG5cblx0bGV0IHdvcmtlck9wdGlvbnMgPSB7XG5cdFx0d29ya2VyRGF0YToge1xuXHRcdFx0dGltZTogbmV3IERhdGUsXG5cdFx0XHQvL2NvdW50OiAwLFxuXHRcdFx0Ly9yZTogLyAgIC9pZyxcblx0XHR9LFxuXHR9O1xuXG5cdGxldCB3MSA9IG5ldyBXb3JrZXIoX19maWxlbmFtZSwgd29ya2VyT3B0aW9ucyk7XG5cdC8vbGV0IHcyID0gbmV3IFdvcmtlcihfX2ZpbGVuYW1lLCB3b3JrZXJPcHRpb25zKTtcblxuLy9cdGNvbnN0IHN1YkNoYW5uZWwgPSBuZXcgTWVzc2FnZUNoYW5uZWwoKTtcbi8vXG4vL1x0dzIucG9zdE1lc3NhZ2Uoe1xuLy9cdFx0aGVyZUlzWW91clBvcnQ6IHN1YkNoYW5uZWwucG9ydDFcbi8vXHR9LCBbc3ViQ2hhbm5lbC5wb3J0MV0pO1xuLy9cdHcxLnBvc3RNZXNzYWdlKHtcbi8vXHRcdGhlcmVJc1lvdXJQb3J0OiBzdWJDaGFubmVsLnBvcnQyXG4vL1x0fSwgW3N1YkNoYW5uZWwucG9ydDJdKTtcblxuXHRsZXQgdGltZURpZmY6IERhdGU7XG5cblx0ZnMucmVtb3ZlU3luYyhDV0RfU0FWRVRPKTtcblxuXHR3MS5vbignbWVzc2FnZScsIChtc2cpID0+XG5cdHtcblxuXHRcdHRpbWVEaWZmID0gbXNnLnRpbWVEaWZmO1xuXG5cdFx0Ly9jb25zb2xlLmRpcihtc2cpO1xuXG5cdFx0bG9nKG1zZy5pbmRleCwgbXNnLmxpc3QubGVuZ3RoKTtcblxuXHRcdGxldCBjYWNoZSA9IHtcblx0XHRcdGNoYXI6IFtdLFxuXHRcdFx0b3RoZXI6IFtdLFxuXHRcdFx0ZW5nOiBbXSxcblx0XHR9IGFzIHtcblx0XHRcdFtrIGluIEVudW1DMSB8IHN0cmluZ106IHN0cmluZ1tdO1xuXHRcdH07XG5cblx0XHR7XG5cdFx0XHRsZXQgaSA9ICdhJy5jb2RlUG9pbnRBdCgwKTtcblx0XHRcdGxldCBqID0gJ3onLmNvZGVQb2ludEF0KDApO1xuXG5cdFx0XHR3aGlsZSAoaSA8PSBqKVxuXHRcdFx0e1xuXHRcdFx0XHRjYWNoZVtTdHJpbmcuZnJvbUNvZGVQb2ludChpKV0gPSBbXTtcblxuXHRcdFx0XHRpKys7XG5cdFx0XHR9XG5cdFx0fVxuXG5cdFx0Y2FjaGUgPSBtc2cubGlzdC5yZWR1Y2UoZnVuY3Rpb24gKGNhY2hlLCBjdXIpXG5cdFx0e1xuXG5cdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRsZXQgeyBjMSwgbGluZSB9ID0gY3VyO1xuXG5cdFx0XHRjYWNoZVtjMV0gPSBjYWNoZVtjMV0gfHwgW107XG5cblx0XHRcdGNhY2hlW2MxXS5wdXNoKEJ1ZmZlci5mcm9tKGxpbmUpLnRvU3RyaW5nKCkpO1xuXG5cdFx0XHRyZXR1cm4gY2FjaGVcblx0XHR9LCBjYWNoZSlcblx0XHQ7XG5cblx0XHRPYmplY3QuZW50cmllcyhjYWNoZSkuZm9yRWFjaChhc3luYyBmdW5jdGlvbiAoW2MxLCBsc10pXG5cdFx0e1xuXHRcdFx0aWYgKCEvXlthLXowLTldJC9pLnRlc3QoYzEpKVxuXHRcdFx0e1xuXHRcdFx0XHRjMSA9ICcwLycgKyBjMTtcblx0XHRcdH1cblxuXHRcdFx0bGV0IGZpbGUgPSBwYXRoLmpvaW4oQ1dEX1NBVkVUTywgYzEgKyAnLnR4dCcpO1xuXG5cdFx0XHRmcy5lbnN1cmVGaWxlU3luYyhmaWxlKTtcblxuXHRcdFx0aWYgKCFscy5sZW5ndGgpXG5cdFx0XHR7XG5cdFx0XHRcdHJldHVybjtcblx0XHRcdH1cblxuXHRcdFx0cmV0dXJuIGZzLmFwcGVuZEZpbGVTeW5jKGZpbGUsIGxzLmpvaW4oJ1xcbicpICsgJ1xcbicpXG5cdFx0fSk7XG5cblx0XHQvL2ZzLmFwcGVuZEZpbGUoKVxuXG5cdH0pO1xuXG5cdHcxLm9uKCdlcnJvcicsIGUgPT4gY29uc29sZS5lcnJvcihjb25zb2xlKSk7XG5cdHcxLm9uKCdleGl0JywgKGNvZGUpID0+XG5cdHtcblxuXHRcdGxldCBib29sID0gdHJ1ZTtcblxuXHRcdHRyeVxuXHRcdHtcblx0XHRcdGxldCBpID0gdGltZURpZmYuZ2V0VGltZSgpIC0gd29ya2VyT3B0aW9ucy53b3JrZXJEYXRhLnRpbWUuZ2V0VGltZSgpO1xuXG5cdFx0XHRsb2coaSwgdGltZURpZmYpO1xuXHRcdH1cblx0XHRjYXRjaCAoZSlcblx0XHR7XG5cdFx0XHRib29sID0gZmFsc2U7XG5cdFx0fVxuXG5cdFx0aWYgKGJvb2wpXG5cdFx0e1xuXHRcdFx0bGV0IGxzID0gRmFzdEdsb2JTeW5jKFtcblx0XHRcdFx0JyoqLyoudHh0J1xuXHRcdFx0XSwge1xuXHRcdFx0XHRjd2Q6IENXRF9TQVZFVE8sXG5cdFx0XHRcdGFic29sdXRlOiB0cnVlLFxuXHRcdFx0fSkuc29ydCgpO1xuXG5cdFx0XHRsZXQgZmlsZTIgPSBwYXRoLmpvaW4oQ1dELCAnc3RyaW5naWZ5LnNvcnRlZC50eHQnKTtcblxuXHRcdFx0ZnMuZW5zdXJlRmlsZVN5bmMoZmlsZTIpO1xuXHRcdFx0ZnMudHJ1bmNhdGVTeW5jKGZpbGUyKTtcblxuXHRcdFx0bGV0IGkyID0gbHMucmVkdWNlKChhLCBmaWxlOiBzdHJpbmcpID0+IHtcblxuXHRcdFx0XHRsb2coJ1tzdGFydF0nLCBwYXRoLnJlbGF0aXZlKENXRF9TQVZFVE8sIGZpbGUpKTtcblxuXHRcdFx0XHRjb25zdCBsaW5lciA9IG5ldyBsaW5lQnlMaW5lKGZpbGUpO1xuXHRcdFx0XHRsZXQgbGluZTogQnVmZmVyO1xuXG5cdFx0XHRcdGxldCBpbmRleCA9IDA7XG5cblx0XHRcdFx0bGV0IGxpc3Q6IElMb2FkRGljdEZpbGVSb3cyW10gPSBbXTtcblxuXHRcdFx0XHR3aGlsZSAobGluZSA9IGxpbmVyLm5leHQoKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdGxldCBzID0gbGluZS50b1N0cmluZygpO1xuXHRcdFx0XHRcdGxldCBkYXRhID0gcGFyc2VMaW5lU2VnbWVudChzKTtcblx0XHRcdFx0XHRsZXQgW3csIHAsIGZdID0gZGF0YTtcblxuXHRcdFx0XHRcdGxldCBjdXI6IElMb2FkRGljdEZpbGVSb3cyID0ge1xuXHRcdFx0XHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0XHRcdFx0ZGF0YSxcblx0XHRcdFx0XHRcdGxpbmU6IHMsXG5cdFx0XHRcdFx0XHRpbmRleDogaW5kZXgrKyxcblx0XHRcdFx0XHRcdGMxOiBFbnVtQzEub3RoZXIgYXMgc3RyaW5nLFxuXHRcdFx0XHRcdFx0bGluZV90eXBlOiBjaGtMaW5lVHlwZShzKSxcblx0XHRcdFx0XHRcdGNqa19pZDogZ2V0Q2prTmFtZSh3KSxcblx0XHRcdFx0XHR9O1xuXG5cdFx0XHRcdFx0bGlzdC5wdXNoKGN1cik7XG5cblx0XHRcdFx0XHRhKys7XG5cdFx0XHRcdH1cblxuXHRcdFx0XHRsaXN0ID0gU29ydExpc3QoIGxpc3QpO1xuXG5cdFx0XHRcdGxldCBvdXRfbGlzdCA9IGxpc3QubWFwKHYgPT4gdi5saW5lKTtcblxuXHRcdFx0XHRvdXRfbGlzdCA9IGFycmF5X3VuaXF1ZShvdXRfbGlzdCk7XG5cblx0XHRcdFx0bGV0IG91dF9kYXRhID0gc2VyaWFsaXplKG91dF9saXN0KTtcblxuXHRcdFx0XHRmcy5vdXRwdXRGaWxlU3luYyhmaWxlLCBvdXRfZGF0YSArIFwiXFxuXFxuXCIpO1xuXG5cdFx0XHRcdGZzLmFwcGVuZEZpbGVTeW5jKGZpbGUyLCBvdXRfZGF0YSArIFwiXFxuXCIpO1xuXG5cdFx0XHRcdGxvZygnW2RvbmVdJywgcGF0aC5yZWxhdGl2ZShDV0RfU0FWRVRPLCBmaWxlKSk7XG5cblx0XHRcdFx0cmV0dXJuIGE7XG5cdFx0XHR9LCAwKTtcblxuXHRcdFx0bG9nKGkyKVxuXHRcdH1cblxuXHRcdGlmIChjb2RlICE9IDApXG5cdFx0e1xuXHRcdFx0Y29uc29sZS5lcnJvcihuZXcgRXJyb3IoYFdvcmtlciBzdG9wcGVkIHdpdGggZXhpdCBjb2RlICR7Y29kZX1gKSlcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdGxvZyhgV29ya2VyIHN0b3BwZWRgKVxuXHRcdH1cblx0fSk7XG5cbn1cbmVsc2Vcbntcbi8vXHRwYXJlbnRQb3J0Lm9uY2UoJ21lc3NhZ2UnLCAodmFsdWUpID0+IHtcbi8vXHRcdHZhbHVlLmhlcmVJc1lvdXJQb3J0LnBvc3RNZXNzYWdlKCdoZWxsbycpO1xuLy9cdFx0dmFsdWUuaGVyZUlzWW91clBvcnQub24oJ21lc3NhZ2UnLCBtc2cgPT4ge1xuLy9cdFx0XHRjb25zb2xlLmxvZyhgdGhyZWFkICR7dGhyZWFkSWR9OiByZWNlaXZlICR7bXNnfWApO1xuLy9cdFx0fSk7XG4vL1x0fSk7XG5cblx0Ly90aGUgd29ya2VyJ3MgY29kZVxuXG5cdGNvbnNvbGUuZGlyKHdvcmtlckRhdGEsIHtcblx0XHRjb2xvcnM6IHRydWUsXG5cdH0pO1xuXG4vL1x0bG9nKHdvcmtlckRhdGEucmUudGVzdCgnICcpKTtcblxuXHRsZXQgZmlsZSA9IHBhdGguam9pbihDV0QsICdzdHJpbmdpZnkudHh0Jyk7XG5cblx0Y29uc3QgbGluZXIgPSBuZXcgbGluZUJ5TGluZShmaWxlKTtcblxuXHRsZXQgbGluZTogQnVmZmVyO1xuXHRsZXQgbGluZU51bWJlciA9IDA7XG5cdGxldCBjb3VudCA9IDA7XG5cblx0bGV0IGMxX29sZDogc3RyaW5nO1xuXG5cdGxldCBsaXN0ID0gW107XG5cblx0d2hpbGUgKGxpbmUgPSBsaW5lci5uZXh0KCkpXG5cdHtcblx0XHQvL2NvbnNvbGUubG9nKCdMaW5lICcgKyBsaW5lTnVtYmVyICsgJzogJyArIGxpbmUudG9TdHJpbmcoJ2FzY2lpJykpO1xuXG5cdFx0bGV0IGluZGV4ID0gbGluZU51bWJlcisrO1xuXG5cdFx0bGV0IGRhdGEgPSBwYXJzZUxpbmVTZWdtZW50KGxpbmUudG9TdHJpbmcoKSk7XG5cblx0XHRsZXQgY3VyID0ge1xuXHRcdFx0ZGF0YSxcblx0XHRcdGxpbmUsXG5cdFx0XHRpbmRleCxcblx0XHRcdGMxOiBFbnVtQzEub3RoZXIgYXMgc3RyaW5nLFxuXHRcdH07XG5cblx0XHRsZXQgW3csIHAsIGZdID0gY3VyLmRhdGE7XG5cblx0XHRsZXQgbGVuID0gVVN0cmluZy5zaXplKHcpO1xuXG5cdFx0bGV0IGMxX25vdzogc3RyaW5nO1xuXG5cdFx0aWYgKGxlbiA+IDEpXG5cdFx0e1xuXHRcdFx0YzFfbm93ID0gZ2V0Q2lkKHcpO1xuXG5cdFx0XHRpZiAoIWMxX25vdylcblx0XHRcdHtcblx0XHRcdFx0Y29uc29sZS5sb2coYzFfbm93LCB3KTtcblxuXHRcdFx0XHR0aHJvdyBuZXcgRXJyb3IoYCR7d30sICR7YzFfbm93fWApO1xuXHRcdFx0fVxuXHRcdH1cblx0XHRlbHNlIGlmIChsZW4gPT09IDEpXG5cdFx0e1xuXHRcdFx0YzFfbm93ID0gRW51bUMxLmNoYXI7XG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRjMV9ub3cgPSBFbnVtQzEub3RoZXI7XG5cdFx0fVxuXG5cdFx0Y3VyLmMxID0gYzFfbm93O1xuXG5cdFx0aWYgKGNvdW50ID49IDEwMDAwKVxuXHRcdHtcblx0XHRcdHBhcmVudFBvcnQucG9zdE1lc3NhZ2Uoe1xuXG5cdFx0XHRcdGluZGV4LFxuXHRcdFx0XHRsaXN0LFxuXG5cdFx0XHR9KTtcblxuXHRcdFx0bGlzdCA9IFtdO1xuXG5cdFx0XHRjb3VudCA9IDA7XG5cdFx0fVxuXG5cdFx0bGlzdC5wdXNoKGN1cik7XG5cblx0XHRjMV9vbGQgPSBjMV9ub3c7XG5cblx0XHRjb3VudCsrO1xuXHR9XG5cblx0bG9nKCdlbmQgb2YgbGluZSByZWFjaGVkJywgbGluZU51bWJlcik7XG5cblx0d29ya2VyRGF0YS5jb3VudCA9IGxpbmVOdW1iZXI7XG5cblx0cGFyZW50UG9ydC5wb3N0TWVzc2FnZSh7XG5cdFx0dGltZURpZmY6IG5ldyBEYXRlLFxuXHRcdGluZGV4OiBsaW5lTnVtYmVyLFxuXHRcdGxpc3QsXG5cdH0pO1xuXG59XG5cbmZ1bmN0aW9uIGxvZyguLi5hcmd2KVxue1xuXHRjb25zb2xlLmxvZyhgW3RocmVhZDoke3RocmVhZElkfV1gLCAuLi5hcmd2KTtcbn1cblxuZnVuY3Rpb24gZ2V0Q2lkKHc6IHN0cmluZylcbntcblx0dyA9IFVTdHJpbmcuc2xpY2UodywgMCwgMSkudG9Mb2NhbGVMb3dlckNhc2UoKTtcblxuXHRpZiAoL15bYS16MC05XSQvaS50ZXN0KHcpKVxuXHR7XG5cdFx0cmV0dXJuIEVudW1DMS5lbmc7XG5cdH1cblxuXHRsZXQgcyA9IGdldENqa05hbWUodyk7XG5cblx0bGV0IHIgPSBzbHVnaWZ5VHIocyk7XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0dHJ5XG5cdFx0e1xuXHRcdFx0ciA9IHNsdWdpZnlUcihwaW55aW4ocylbMF1bMF0pO1xuXHRcdH1cblx0XHRjYXRjaCAoZSlcblx0XHR7XG5cblx0XHR9XG5cdH1cblxuXHRpZiAoIXIpXG5cdHtcblx0XHR0cnlcblx0XHR7XG5cdFx0XHRyID0gc2x1Z2lmeVRyKHBpbnlpbih3KVswXVswXSk7XG5cdFx0fVxuXHRcdGNhdGNoIChlKVxuXHRcdHtcblxuXHRcdH1cblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIoZ3JlZWR5VGFibGVSZXBsYWNlKHMpKTtcblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdGxldCBhcnIgPSBsaWJUYWJsZS5hdXRvKHMsIHtcblx0XHRcdHNhZmU6IGZhbHNlLFxuXHRcdFx0Z3JlZWR5VGFibGU6IDIsXG5cdFx0fSk7XG5cblx0XHRpZiAoYXJyLmxlbmd0aClcblx0XHR7XG5cdFx0XHRyID0gc2x1Z2lmeVRyKGFyclsxXSB8fCBhcnJbMF0pO1xuXHRcdH1cblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdGxldCBhcnIgPSBsaWJUYWJsZS5hdXRvKHcsIHtcblx0XHRcdHNhZmU6IGZhbHNlLFxuXHRcdFx0Z3JlZWR5VGFibGU6IDIsXG5cdFx0fSk7XG5cblx0XHRpZiAoYXJyLmxlbmd0aClcblx0XHR7XG5cdFx0XHRyID0gc2x1Z2lmeVRyKGFyclsxXSB8fCBhcnJbMF0pO1xuXHRcdH1cblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIoY2prMnpocyhzKSk7XG5cdH1cblxuXHRpZiAoIXIpXG5cdHtcblx0XHRyID0gc2x1Z2lmeVRyKGNqazJ6aHQocykpO1xuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0ciA9IHNsdWdpZnlUcihjamsyemhzKHcpKTtcblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIoY2prMnpodCh3KSk7XG5cdH1cblxuXHRpZiAoIXIpXG5cdHtcblx0XHRyID0gc2x1Z2lmeVRyKHcpO1xuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0ciA9IHc7XG5cdH1cblxuXHRsZXQgcjIgPSBVU3RyaW5nLnNsaWNlKHIsIDAsIDEpO1xuXG5cdGlmICghL15bYS16MC05XSQvaS50ZXN0KHIyKSlcblx0e1xuXHRcdHIyID0gRW51bUMxLm90aGVyO1xuXHR9XG5cblx0cmV0dXJuIHIyLnRvTG9jYWxlTG93ZXJDYXNlKClcbn1cblxuZnVuY3Rpb24gU29ydExpc3Q8VCA9IElMb2FkRGljdEZpbGVSb3cyPihsczogVFtdKVxue1xuXHQvLyBAdHMtaWdub3JlXG5cdHJldHVybiBscy5zb3J0KGZ1bmN0aW9uIChhOiBJTG9hZERpY3RGaWxlUm93MiwgYjogSUxvYWREaWN0RmlsZVJvdzIpXG5cdHtcblx0XHRpZiAoXG5cdFx0XHRhLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVF9UQUdcblx0XHRcdHx8IGIubGluZV90eXBlID09IEVudW1MaW5lVHlwZS5DT01NRU5UX1RBR1xuXHRcdClcblx0XHR7XG5cdFx0XHRyZXR1cm4gKGEuaW5kZXggLSBiLmluZGV4KTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAoXG5cdFx0XHRhLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVFxuXHRcdFx0fHwgYi5saW5lX3R5cGUgPT0gRW51bUxpbmVUeXBlLkNPTU1FTlRcblx0XHQpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIChhLmluZGV4IC0gYi5pbmRleCk7XG5cdFx0fVxuXG5cdFx0bGV0IHJldCA9IHpoRGljdENvbXBhcmUoYS5jamtfaWQsIGIuY2prX2lkKVxuXHRcdFx0fHwgKGEuaW5kZXggLSBiLmluZGV4KVxuXHRcdFx0fHwgMFxuXHRcdDtcblxuXHRcdHJldHVybiByZXQ7XG5cdH0pXG59XG4iXX0=