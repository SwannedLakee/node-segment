"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const worker_threads_1 = require("worker_threads");
const lineByLine = require("n-readlines");
const project_config_1 = require("../project.config");
const path = require("upath2");
const index_1 = require("segment-dict/lib/loader/segment/index");
const uni_string_1 = require("uni-string");
const util_1 = require("@novel-segment/util");
const transliteration_1 = require("transliteration");
const fs = require("fs-extra");
const cjk_conv_1 = require("cjk-conv");
const fast_glob_1 = require("fast-glob");
const util_2 = require("segment-dict/script/util");
const array_hyper_unique_1 = require("array-hyper-unique");
const line_1 = require("segment-dict/lib/loader/line");
const debug_color2_1 = require("debug-color2");
const greedy_1 = require("cjk-conv/lib/zh/table/greedy");
const table_1 = require("cjk-conv/lib/zh/table");
const diff_staged_1 = require("@git-lazy/diff-staged");
const match_1 = require("@git-lazy/util/util/match");
let CWD = path.join(project_config_1.default.temp_root);
var EnumC1;
(function (EnumC1) {
    EnumC1["char"] = "char";
    EnumC1["other"] = "other";
    EnumC1["eng"] = "eng";
})(EnumC1 || (EnumC1 = {}));
const CWD_SAVETO = path.join(CWD, 'cache');
if (0 && (!fs.pathExistsSync(path.join(CWD, 'stringify.txt')) || !match_1.matchGlob(diff_staged_1.gitDiffStagedFile(CWD), [
    'cache.db.info.json'
]).length)) {
    process.exit();
}
if (worker_threads_1.isMainThread) {
    log("This is the main thread", worker_threads_1.threadId);
    let workerOptions = {
        workerData: {
            time: new Date,
        },
    };
    let w1 = new worker_threads_1.Worker(__filename, workerOptions);
    //let w2 = new Worker(__filename, workerOptions);
    //	const subChannel = new MessageChannel();
    //
    //	w2.postMessage({
    //		hereIsYourPort: subChannel.port1
    //	}, [subChannel.port1]);
    //	w1.postMessage({
    //		hereIsYourPort: subChannel.port2
    //	}, [subChannel.port2]);
    let timeDiff;
    fs.removeSync(CWD_SAVETO);
    w1.on('message', (msg) => {
        timeDiff = msg.timeDiff;
        //console.dir(msg);
        log(msg.index, msg.list.length);
        let cache = {
            char: [],
            other: [],
            eng: [],
        };
        {
            let i = 'a'.codePointAt(0);
            let j = 'z'.codePointAt(0);
            while (i <= j) {
                cache[String.fromCodePoint(i)] = [];
                i++;
            }
        }
        cache = msg.list.reduce(function (cache, cur) {
            // @ts-ignore
            let { c1, line } = cur;
            cache[c1] = cache[c1] || [];
            cache[c1].push(Buffer.from(line).toString());
            return cache;
        }, cache);
        Object.entries(cache).forEach(async function ([c1, ls]) {
            if (!/^[a-z0-9]$/i.test(c1)) {
                c1 = '0/' + c1;
            }
            let file = path.join(CWD_SAVETO, c1 + '.txt');
            fs.ensureFileSync(file);
            if (!ls.length) {
                return;
            }
            return fs.appendFileSync(file, ls.join('\n') + '\n');
        });
        //fs.appendFile()
    });
    w1.on('error', e => debug_color2_1.console.error(debug_color2_1.console));
    w1.on('exit', (code) => {
        let bool = true;
        try {
            let i = timeDiff.getTime() - workerOptions.workerData.time.getTime();
            log(i, timeDiff);
        }
        catch (e) {
            bool = false;
        }
        if (bool) {
            let ls = fast_glob_1.sync([
                '**/*.txt'
            ], {
                cwd: CWD_SAVETO,
                absolute: true,
            }).sort();
            let file2 = path.join(CWD, 'stringify.sorted.txt');
            fs.ensureFileSync(file2);
            fs.truncateSync(file2);
            let i2 = ls.reduce((a, file) => {
                log('[start]', path.relative(CWD_SAVETO, file));
                const liner = new lineByLine(file);
                let line;
                let index = 0;
                let list = [];
                while (line = liner.next()) {
                    let s = line.toString();
                    let data = index_1.parseLine(s);
                    let [w, p, f] = data;
                    let cur = {
                        // @ts-ignore
                        data,
                        line: s,
                        index: index++,
                        c1: "other" /* other */,
                        line_type: util_2.chkLineType(s),
                        cjk_id: util_1.getCjkName(w),
                    };
                    list.push(cur);
                    a++;
                }
                list = SortList(list);
                let out_list = list.map(v => v.line);
                out_list = array_hyper_unique_1.array_unique(out_list);
                let out_data = line_1.serialize(out_list);
                fs.outputFileSync(file, out_data + "\n\n");
                fs.appendFileSync(file2, out_data + "\n");
                log('[done]', path.relative(CWD_SAVETO, file));
                return a;
            }, 0);
            log(i2);
        }
        if (code != 0) {
            debug_color2_1.console.error(new Error(`Worker stopped with exit code ${code}`));
        }
        else {
            log(`Worker stopped`);
        }
    });
}
else {
    //	parentPort.once('message', (value) => {
    //		value.hereIsYourPort.postMessage('hello');
    //		value.hereIsYourPort.on('message', msg => {
    //			console.log(`thread ${threadId}: receive ${msg}`);
    //		});
    //	});
    //the worker's code
    debug_color2_1.console.dir(worker_threads_1.workerData, {
        colors: true,
    });
    //	log(workerData.re.test(' '));
    let file = path.join(CWD, 'stringify.txt');
    const liner = new lineByLine(file);
    let line;
    let lineNumber = 0;
    let count = 0;
    let c1_old;
    let list = [];
    while (line = liner.next()) {
        //console.log('Line ' + lineNumber + ': ' + line.toString('ascii'));
        let index = lineNumber++;
        let data = index_1.parseLine(line.toString());
        let cur = {
            data,
            line,
            index,
            c1: "other" /* other */,
        };
        let [w, p, f] = cur.data;
        let len = uni_string_1.default.size(w);
        let c1_now;
        if (len > 1) {
            c1_now = getCid(w);
            if (!c1_now) {
                debug_color2_1.console.log(c1_now, w);
                throw new Error(`${w}, ${c1_now}`);
            }
        }
        else if (len === 1) {
            c1_now = "char" /* char */;
        }
        else {
            c1_now = "other" /* other */;
        }
        cur.c1 = c1_now;
        if (count >= 10000) {
            worker_threads_1.parentPort.postMessage({
                index,
                list,
            });
            list = [];
            count = 0;
        }
        list.push(cur);
        c1_old = c1_now;
        count++;
    }
    log('end of line reached', lineNumber);
    worker_threads_1.workerData.count = lineNumber;
    worker_threads_1.parentPort.postMessage({
        timeDiff: new Date,
        index: lineNumber,
        list,
    });
}
function log(...argv) {
    debug_color2_1.console.log(`[thread:${worker_threads_1.threadId}]`, ...argv);
}
function getCid(w) {
    w = uni_string_1.default.slice(w, 0, 1).toLocaleLowerCase();
    if (/^[a-z0-9]$/i.test(w)) {
        return "eng" /* eng */;
    }
    let s = util_1.getCjkName(w);
    let r = transliteration_1.slugify(s);
    if (!r) {
        r = transliteration_1.slugify(greedy_1.greedyTableReplace(s));
    }
    if (!r) {
        let arr = table_1.default.auto(s, {
            safe: false,
            greedyTable: 2,
        });
        if (arr.length) {
            r = transliteration_1.slugify(arr[1] || arr[0]);
        }
    }
    if (!r) {
        let arr = table_1.default.auto(w, {
            safe: false,
            greedyTable: 2,
        });
        if (arr.length) {
            r = transliteration_1.slugify(arr[1] || arr[0]);
        }
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zhs(s));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zht(s));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zhs(w));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zht(w));
    }
    if (!r) {
        r = transliteration_1.slugify(w);
    }
    if (!r) {
        r = w;
    }
    let r2 = uni_string_1.default.slice(r, 0, 1);
    if (!/^[a-z0-9]$/i.test(r2)) {
        r2 = "other" /* other */;
    }
    return r2.toLocaleLowerCase();
}
function SortList(ls) {
    // @ts-ignore
    return ls.sort(function (a, b) {
        if (a.line_type == util_2.EnumLineType.COMMENT_TAG
            || b.line_type == util_2.EnumLineType.COMMENT_TAG) {
            return (a.index - b.index);
        }
        else if (a.line_type == util_2.EnumLineType.COMMENT
            || b.line_type == util_2.EnumLineType.COMMENT) {
            return (a.index - b.index);
        }
        let ret = util_1.zhDictCompare(a.cjk_id, b.cjk_id)
            || (a.index - b.index)
            || 0;
        return ret;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydC1zdHJpbmdpZnktY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzb3J0LXN0cmluZ2lmeS1jYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQVF3QjtBQUN4QiwwQ0FBMkM7QUFDM0Msc0RBQThDO0FBQzlDLCtCQUErQjtBQUMvQixpRUFBK0g7QUFDL0gsMkNBQWlDO0FBQ2pDLDhDQUFnRTtBQUNoRSxxREFBNEU7QUFDNUUsK0JBQWdDO0FBRWhDLHVDQUE0QztBQUU1Qyx5Q0FBaUQ7QUFDakQsbURBQXdGO0FBQ3hGLDJEQUFrRDtBQUNsRCx1REFBeUQ7QUFDekQsK0NBQXVEO0FBQ3ZELHlEQUFrRTtBQUNsRSxpREFBNkM7QUFDN0MsdURBQTBEO0FBQzFELHFEQUFzRDtBQUV0RCxJQUFJLEdBQUcsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLHdCQUFhLENBQUMsU0FBUyxDQUFDLENBQUM7QUFFN0MsSUFBVyxNQUtWO0FBTEQsV0FBVyxNQUFNO0lBRWhCLHVCQUFhLENBQUE7SUFDYix5QkFBZSxDQUFBO0lBQ2YscUJBQVcsQ0FBQTtBQUNaLENBQUMsRUFMVSxNQUFNLEtBQU4sTUFBTSxRQUtoQjtBQUVELE1BQU0sVUFBVSxHQUFHLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLE9BQU8sQ0FBQyxDQUFDO0FBRTNDLElBQUksQ0FBQyxJQUFJLENBQUMsQ0FBQyxFQUFFLENBQUMsY0FBYyxDQUFDLElBQUksQ0FBQyxJQUFJLENBQUMsR0FBRyxFQUFFLGVBQWUsQ0FBQyxDQUFDLElBQUksQ0FBQyxpQkFBUyxDQUFDLCtCQUFpQixDQUFDLEdBQUcsQ0FBQyxFQUFFO0lBQ25HLG9CQUFvQjtDQUNwQixDQUFDLENBQUMsTUFBTSxDQUFDLEVBQ1Y7SUFDQyxPQUFPLENBQUMsSUFBSSxFQUFFLENBQUM7Q0FDZjtBQUVELElBQUksNkJBQVksRUFDaEI7SUFDQyxHQUFHLENBQUMseUJBQXlCLEVBQUUseUJBQVEsQ0FB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Q0FBQyxXQUFXLEVBRTNDO1lBQ0MsT0FBTyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQyxDQUFDO1NBQzNCO2FBQ0ksSUFDSixDQUFDLENBQUMsU0FBUyxJQUFJLG1CQUFZLENBQUMsT0FBTztlQUNoQyxDQUFDLENBQUMsU0FBUyxJQUFJLG1CQUFZLENBQUMsT0FBTyxFQUV2QztZQUNDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMzQjtRQUVELElBQUksR0FBRyxHQUFHLG9CQUFhLENBQUMsQ0FBQyxDQUFDLE1BQU0sRUFBRSxDQUFDLENBQUMsTUFBTSxDQUFDO2VBQ3ZDLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDO2VBQ25CLENBQUMsQ0FDSjtRQUVELE9BQU8sR0FBRyxDQUFDO0lBQ1osQ0FBQyxDQUFDLENBQUE7QUFDSCxDQUFDIiwic291cmNlc0NvbnRlbnQiOlsiaW1wb3J0IHtcblx0V29ya2VyLFxuXHRpc01haW5UaHJlYWQsXG5cdHBhcmVudFBvcnQsXG5cdHdvcmtlckRhdGEsXG5cdHRocmVhZElkLFxuXHRNZXNzYWdlQ2hhbm5lbCxcblx0TWVzc2FnZVBvcnQsXG59IGZyb20gJ3dvcmtlcl90aHJlYWRzJztcbmltcG9ydCBsaW5lQnlMaW5lID0gcmVxdWlyZSgnbi1yZWFkbGluZXMnKTtcbmltcG9ydCBQcm9qZWN0Q29uZmlnIGZyb20gJy4uL3Byb2plY3QuY29uZmlnJztcbmltcG9ydCAqIGFzIHBhdGggZnJvbSBcInVwYXRoMlwiO1xuaW1wb3J0IHsgSURpY3RSb3csIHBhcnNlTGluZSBhcyBwYXJzZUxpbmVTZWdtZW50LCBzZXJpYWxpemUgYXMgc2VyaWFsaXplU2VnbWVudCB9IGZyb20gJ3NlZ21lbnQtZGljdC9saWIvbG9hZGVyL3NlZ21lbnQvaW5kZXgnO1xuaW1wb3J0IFVTdHJpbmcgZnJvbSAndW5pLXN0cmluZyc7XG5pbXBvcnQgeyBnZXRDamtOYW1lLCB6aERpY3RDb21wYXJlIH0gZnJvbSAnQG5vdmVsLXNlZ21lbnQvdXRpbCc7XG5pbXBvcnQgeyB0cmFuc2xpdGVyYXRlIGFzIHRyLCBzbHVnaWZ5IGFzIHNsdWdpZnlUciB9IGZyb20gJ3RyYW5zbGl0ZXJhdGlvbic7XG5pbXBvcnQgZnMgPSByZXF1aXJlKCdmcy1leHRyYScpO1xuaW1wb3J0IEJsdWViaXJkID0gcmVxdWlyZSgnYmx1ZWJpcmQnKTtcbmltcG9ydCB7IGNqazJ6aHMsIGNqazJ6aHQgfSBmcm9tICdjamstY29udic7XG5pbXBvcnQgU3RyVXRpbCA9IHJlcXVpcmUoJ3N0ci11dGlsJyk7XG5pbXBvcnQgeyBzeW5jIGFzIEZhc3RHbG9iU3luYyB9IGZyb20gJ2Zhc3QtZ2xvYic7XG5pbXBvcnQgeyBjaGtMaW5lVHlwZSwgRW51bUxpbmVUeXBlLCBJTG9hZERpY3RGaWxlUm93MiB9IGZyb20gJ3NlZ21lbnQtZGljdC9zY3JpcHQvdXRpbCc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUgfSBmcm9tICdhcnJheS1oeXBlci11bmlxdWUnO1xuaW1wb3J0IHsgc2VyaWFsaXplIH0gZnJvbSAnc2VnbWVudC1kaWN0L2xpYi9sb2FkZXIvbGluZSc7XG5pbXBvcnQgeyBjb25zb2xlLCBjaGFsa0J5Q29uc29sZSB9IGZyb20gJ2RlYnVnLWNvbG9yMic7XG5pbXBvcnQgeyBncmVlZHlUYWJsZVJlcGxhY2UgfSBmcm9tICdjamstY29udi9saWIvemgvdGFibGUvZ3JlZWR5JztcbmltcG9ydCBsaWJUYWJsZSBmcm9tICdjamstY29udi9saWIvemgvdGFibGUnO1xuaW1wb3J0IHsgZ2l0RGlmZlN0YWdlZEZpbGUgfSBmcm9tICdAZ2l0LWxhenkvZGlmZi1zdGFnZWQnO1xuaW1wb3J0IHsgbWF0Y2hHbG9iIH0gZnJvbSAnQGdpdC1sYXp5L3V0aWwvdXRpbC9tYXRjaCc7XG5cbmxldCBDV0QgPSBwYXRoLmpvaW4oUHJvamVjdENvbmZpZy50ZW1wX3Jvb3QpO1xuXG5jb25zdCBlbnVtIEVudW1DMVxue1xuXHRjaGFyID0gJ2NoYXInLFxuXHRvdGhlciA9ICdvdGhlcicsXG5cdGVuZyA9ICdlbmcnLFxufVxuXG5jb25zdCBDV0RfU0FWRVRPID0gcGF0aC5qb2luKENXRCwgJ2NhY2hlJyk7XG5cbmlmICgwICYmICghZnMucGF0aEV4aXN0c1N5bmMocGF0aC5qb2luKENXRCwgJ3N0cmluZ2lmeS50eHQnKSkgfHwgIW1hdGNoR2xvYihnaXREaWZmU3RhZ2VkRmlsZShDV0QpLCBbXG5cdCdjYWNoZS5kYi5pbmZvLmpzb24nXG5dKS5sZW5ndGgpKVxue1xuXHRwcm9jZXNzLmV4aXQoKTtcbn1cblxuaWYgKGlzTWFpblRocmVhZClcbntcblx0bG9nKFwiVGhpcyBpcyB0aGUgbWFpbiB0aHJlYWRcIiwgdGhyZWFkSWQpO1xuXG5cdGxldCB3b3JrZXJPcHRpb25zID0ge1xuXHRcdHdvcmtlckRhdGE6IHtcblx0XHRcdHRpbWU6IG5ldyBEYXRlLFxuXHRcdFx0Ly9jb3VudDogMCxcblx0XHRcdC8vcmU6IC8gICAvaWcsXG5cdFx0fSxcblx0fTtcblxuXHRsZXQgdzEgPSBuZXcgV29ya2VyKF9fZmlsZW5hbWUsIHdvcmtlck9wdGlvbnMpO1xuXHQvL2xldCB3MiA9IG5ldyBXb3JrZXIoX19maWxlbmFtZSwgd29ya2VyT3B0aW9ucyk7XG5cbi8vXHRjb25zdCBzdWJDaGFubmVsID0gbmV3IE1lc3NhZ2VDaGFubmVsKCk7XG4vL1xuLy9cdHcyLnBvc3RNZXNzYWdlKHtcbi8vXHRcdGhlcmVJc1lvdXJQb3J0OiBzdWJDaGFubmVsLnBvcnQxXG4vL1x0fSwgW3N1YkNoYW5uZWwucG9ydDFdKTtcbi8vXHR3MS5wb3N0TWVzc2FnZSh7XG4vL1x0XHRoZXJlSXNZb3VyUG9ydDogc3ViQ2hhbm5lbC5wb3J0MlxuLy9cdH0sIFtzdWJDaGFubmVsLnBvcnQyXSk7XG5cblx0bGV0IHRpbWVEaWZmOiBEYXRlO1xuXG5cdGZzLnJlbW92ZVN5bmMoQ1dEX1NBVkVUTyk7XG5cblx0dzEub24oJ21lc3NhZ2UnLCAobXNnKSA9PlxuXHR7XG5cblx0XHR0aW1lRGlmZiA9IG1zZy50aW1lRGlmZjtcblxuXHRcdC8vY29uc29sZS5kaXIobXNnKTtcblxuXHRcdGxvZyhtc2cuaW5kZXgsIG1zZy5saXN0Lmxlbmd0aCk7XG5cblx0XHRsZXQgY2FjaGUgPSB7XG5cdFx0XHRjaGFyOiBbXSxcblx0XHRcdG90aGVyOiBbXSxcblx0XHRcdGVuZzogW10sXG5cdFx0fSBhcyB7XG5cdFx0XHRbayBpbiBFbnVtQzEgfCBzdHJpbmddOiBzdHJpbmdbXTtcblx0XHR9O1xuXG5cdFx0e1xuXHRcdFx0bGV0IGkgPSAnYScuY29kZVBvaW50QXQoMCk7XG5cdFx0XHRsZXQgaiA9ICd6Jy5jb2RlUG9pbnRBdCgwKTtcblxuXHRcdFx0d2hpbGUgKGkgPD0gailcblx0XHRcdHtcblx0XHRcdFx0Y2FjaGVbU3RyaW5nLmZyb21Db2RlUG9pbnQoaSldID0gW107XG5cblx0XHRcdFx0aSsrO1xuXHRcdFx0fVxuXHRcdH1cblxuXHRcdGNhY2hlID0gbXNnLmxpc3QucmVkdWNlKGZ1bmN0aW9uIChjYWNoZSwgY3VyKVxuXHRcdHtcblxuXHRcdFx0Ly8gQHRzLWlnbm9yZVxuXHRcdFx0bGV0IHsgYzEsIGxpbmUgfSA9IGN1cjtcblxuXHRcdFx0Y2FjaGVbYzFdID0gY2FjaGVbYzFdIHx8IFtdO1xuXG5cdFx0XHRjYWNoZVtjMV0ucHVzaChCdWZmZXIuZnJvbShsaW5lKS50b1N0cmluZygpKTtcblxuXHRcdFx0cmV0dXJuIGNhY2hlXG5cdFx0fSwgY2FjaGUpXG5cdFx0O1xuXG5cdFx0T2JqZWN0LmVudHJpZXMoY2FjaGUpLmZvckVhY2goYXN5bmMgZnVuY3Rpb24gKFtjMSwgbHNdKVxuXHRcdHtcblx0XHRcdGlmICghL15bYS16MC05XSQvaS50ZXN0KGMxKSlcblx0XHRcdHtcblx0XHRcdFx0YzEgPSAnMC8nICsgYzE7XG5cdFx0XHR9XG5cblx0XHRcdGxldCBmaWxlID0gcGF0aC5qb2luKENXRF9TQVZFVE8sIGMxICsgJy50eHQnKTtcblxuXHRcdFx0ZnMuZW5zdXJlRmlsZVN5bmMoZmlsZSk7XG5cblx0XHRcdGlmICghbHMubGVuZ3RoKVxuXHRcdFx0e1xuXHRcdFx0XHRyZXR1cm47XG5cdFx0XHR9XG5cblx0XHRcdHJldHVybiBmcy5hcHBlbmRGaWxlU3luYyhmaWxlLCBscy5qb2luKCdcXG4nKSArICdcXG4nKVxuXHRcdH0pO1xuXG5cdFx0Ly9mcy5hcHBlbmRGaWxlKClcblxuXHR9KTtcblxuXHR3MS5vbignZXJyb3InLCBlID0+IGNvbnNvbGUuZXJyb3IoY29uc29sZSkpO1xuXHR3MS5vbignZXhpdCcsIChjb2RlKSA9PlxuXHR7XG5cblx0XHRsZXQgYm9vbCA9IHRydWU7XG5cblx0XHR0cnlcblx0XHR7XG5cdFx0XHRsZXQgaSA9IHRpbWVEaWZmLmdldFRpbWUoKSAtIHdvcmtlck9wdGlvbnMud29ya2VyRGF0YS50aW1lLmdldFRpbWUoKTtcblxuXHRcdFx0bG9nKGksIHRpbWVEaWZmKTtcblx0XHR9XG5cdFx0Y2F0Y2ggKGUpXG5cdFx0e1xuXHRcdFx0Ym9vbCA9IGZhbHNlO1xuXHRcdH1cblxuXHRcdGlmIChib29sKVxuXHRcdHtcblx0XHRcdGxldCBscyA9IEZhc3RHbG9iU3luYyhbXG5cdFx0XHRcdCcqKi8qLnR4dCdcblx0XHRcdF0sIHtcblx0XHRcdFx0Y3dkOiBDV0RfU0FWRVRPLFxuXHRcdFx0XHRhYnNvbHV0ZTogdHJ1ZSxcblx0XHRcdH0pLnNvcnQoKTtcblxuXHRcdFx0bGV0IGZpbGUyID0gcGF0aC5qb2luKENXRCwgJ3N0cmluZ2lmeS5zb3J0ZWQudHh0Jyk7XG5cblx0XHRcdGZzLmVuc3VyZUZpbGVTeW5jKGZpbGUyKTtcblx0XHRcdGZzLnRydW5jYXRlU3luYyhmaWxlMik7XG5cblx0XHRcdGxldCBpMiA9IGxzLnJlZHVjZSgoYSwgZmlsZTogc3RyaW5nKSA9PiB7XG5cblx0XHRcdFx0bG9nKCdbc3RhcnRdJywgcGF0aC5yZWxhdGl2ZShDV0RfU0FWRVRPLCBmaWxlKSk7XG5cblx0XHRcdFx0Y29uc3QgbGluZXIgPSBuZXcgbGluZUJ5TGluZShmaWxlKTtcblx0XHRcdFx0bGV0IGxpbmU6IEJ1ZmZlcjtcblxuXHRcdFx0XHRsZXQgaW5kZXggPSAwO1xuXG5cdFx0XHRcdGxldCBsaXN0OiBJTG9hZERpY3RGaWxlUm93MltdID0gW107XG5cblx0XHRcdFx0d2hpbGUgKGxpbmUgPSBsaW5lci5uZXh0KCkpXG5cdFx0XHRcdHtcblx0XHRcdFx0XHRsZXQgcyA9IGxpbmUudG9TdHJpbmcoKTtcblx0XHRcdFx0XHRsZXQgZGF0YSA9IHBhcnNlTGluZVNlZ21lbnQocyk7XG5cdFx0XHRcdFx0bGV0IFt3LCBwLCBmXSA9IGRhdGE7XG5cblx0XHRcdFx0XHRsZXQgY3VyOiBJTG9hZERpY3RGaWxlUm93MiA9IHtcblx0XHRcdFx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdFx0XHRcdGRhdGEsXG5cdFx0XHRcdFx0XHRsaW5lOiBzLFxuXHRcdFx0XHRcdFx0aW5kZXg6IGluZGV4KyssXG5cdFx0XHRcdFx0XHRjMTogRW51bUMxLm90aGVyIGFzIHN0cmluZyxcblx0XHRcdFx0XHRcdGxpbmVfdHlwZTogY2hrTGluZVR5cGUocyksXG5cdFx0XHRcdFx0XHRjamtfaWQ6IGdldENqa05hbWUodyksXG5cdFx0XHRcdFx0fTtcblxuXHRcdFx0XHRcdGxpc3QucHVzaChjdXIpO1xuXG5cdFx0XHRcdFx0YSsrO1xuXHRcdFx0XHR9XG5cblx0XHRcdFx0bGlzdCA9IFNvcnRMaXN0KCBsaXN0KTtcblxuXHRcdFx0XHRsZXQgb3V0X2xpc3QgPSBsaXN0Lm1hcCh2ID0+IHYubGluZSk7XG5cblx0XHRcdFx0b3V0X2xpc3QgPSBhcnJheV91bmlxdWUob3V0X2xpc3QpO1xuXG5cdFx0XHRcdGxldCBvdXRfZGF0YSA9IHNlcmlhbGl6ZShvdXRfbGlzdCk7XG5cblx0XHRcdFx0ZnMub3V0cHV0RmlsZVN5bmMoZmlsZSwgb3V0X2RhdGEgKyBcIlxcblxcblwiKTtcblxuXHRcdFx0XHRmcy5hcHBlbmRGaWxlU3luYyhmaWxlMiwgb3V0X2RhdGEgKyBcIlxcblwiKTtcblxuXHRcdFx0XHRsb2coJ1tkb25lXScsIHBhdGgucmVsYXRpdmUoQ1dEX1NBVkVUTywgZmlsZSkpO1xuXG5cdFx0XHRcdHJldHVybiBhO1xuXHRcdFx0fSwgMCk7XG5cblx0XHRcdGxvZyhpMilcblx0XHR9XG5cblx0XHRpZiAoY29kZSAhPSAwKVxuXHRcdHtcblx0XHRcdGNvbnNvbGUuZXJyb3IobmV3IEVycm9yKGBXb3JrZXIgc3RvcHBlZCB3aXRoIGV4aXQgY29kZSAke2NvZGV9YCkpXG5cdFx0fVxuXHRcdGVsc2Vcblx0XHR7XG5cdFx0XHRsb2coYFdvcmtlciBzdG9wcGVkYClcblx0XHR9XG5cdH0pO1xuXG59XG5lbHNlXG57XG4vL1x0cGFyZW50UG9ydC5vbmNlKCdtZXNzYWdlJywgKHZhbHVlKSA9PiB7XG4vL1x0XHR2YWx1ZS5oZXJlSXNZb3VyUG9ydC5wb3N0TWVzc2FnZSgnaGVsbG8nKTtcbi8vXHRcdHZhbHVlLmhlcmVJc1lvdXJQb3J0Lm9uKCdtZXNzYWdlJywgbXNnID0+IHtcbi8vXHRcdFx0Y29uc29sZS5sb2coYHRocmVhZCAke3RocmVhZElkfTogcmVjZWl2ZSAke21zZ31gKTtcbi8vXHRcdH0pO1xuLy9cdH0pO1xuXG5cdC8vdGhlIHdvcmtlcidzIGNvZGVcblxuXHRjb25zb2xlLmRpcih3b3JrZXJEYXRhLCB7XG5cdFx0Y29sb3JzOiB0cnVlLFxuXHR9KTtcblxuLy9cdGxvZyh3b3JrZXJEYXRhLnJlLnRlc3QoJyAnKSk7XG5cblx0bGV0IGZpbGUgPSBwYXRoLmpvaW4oQ1dELCAnc3RyaW5naWZ5LnR4dCcpO1xuXG5cdGNvbnN0IGxpbmVyID0gbmV3IGxpbmVCeUxpbmUoZmlsZSk7XG5cblx0bGV0IGxpbmU6IEJ1ZmZlcjtcblx0bGV0IGxpbmVOdW1iZXIgPSAwO1xuXHRsZXQgY291bnQgPSAwO1xuXG5cdGxldCBjMV9vbGQ6IHN0cmluZztcblxuXHRsZXQgbGlzdCA9IFtdO1xuXG5cdHdoaWxlIChsaW5lID0gbGluZXIubmV4dCgpKVxuXHR7XG5cdFx0Ly9jb25zb2xlLmxvZygnTGluZSAnICsgbGluZU51bWJlciArICc6ICcgKyBsaW5lLnRvU3RyaW5nKCdhc2NpaScpKTtcblxuXHRcdGxldCBpbmRleCA9IGxpbmVOdW1iZXIrKztcblxuXHRcdGxldCBkYXRhID0gcGFyc2VMaW5lU2VnbWVudChsaW5lLnRvU3RyaW5nKCkpO1xuXG5cdFx0bGV0IGN1ciA9IHtcblx0XHRcdGRhdGEsXG5cdFx0XHRsaW5lLFxuXHRcdFx0aW5kZXgsXG5cdFx0XHRjMTogRW51bUMxLm90aGVyIGFzIHN0cmluZyxcblx0XHR9O1xuXG5cdFx0bGV0IFt3LCBwLCBmXSA9IGN1ci5kYXRhO1xuXG5cdFx0bGV0IGxlbiA9IFVTdHJpbmcuc2l6ZSh3KTtcblxuXHRcdGxldCBjMV9ub3c6IHN0cmluZztcblxuXHRcdGlmIChsZW4gPiAxKVxuXHRcdHtcblx0XHRcdGMxX25vdyA9IGdldENpZCh3KTtcblxuXHRcdFx0aWYgKCFjMV9ub3cpXG5cdFx0XHR7XG5cdFx0XHRcdGNvbnNvbGUubG9nKGMxX25vdywgdyk7XG5cblx0XHRcdFx0dGhyb3cgbmV3IEVycm9yKGAke3d9LCAke2MxX25vd31gKTtcblx0XHRcdH1cblx0XHR9XG5cdFx0ZWxzZSBpZiAobGVuID09PSAxKVxuXHRcdHtcblx0XHRcdGMxX25vdyA9IEVudW1DMS5jaGFyO1xuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0YzFfbm93ID0gRW51bUMxLm90aGVyO1xuXHRcdH1cblxuXHRcdGN1ci5jMSA9IGMxX25vdztcblxuXHRcdGlmIChjb3VudCA+PSAxMDAwMClcblx0XHR7XG5cdFx0XHRwYXJlbnRQb3J0LnBvc3RNZXNzYWdlKHtcblxuXHRcdFx0XHRpbmRleCxcblx0XHRcdFx0bGlzdCxcblxuXHRcdFx0fSk7XG5cblx0XHRcdGxpc3QgPSBbXTtcblxuXHRcdFx0Y291bnQgPSAwO1xuXHRcdH1cblxuXHRcdGxpc3QucHVzaChjdXIpO1xuXG5cdFx0YzFfb2xkID0gYzFfbm93O1xuXG5cdFx0Y291bnQrKztcblx0fVxuXG5cdGxvZygnZW5kIG9mIGxpbmUgcmVhY2hlZCcsIGxpbmVOdW1iZXIpO1xuXG5cdHdvcmtlckRhdGEuY291bnQgPSBsaW5lTnVtYmVyO1xuXG5cdHBhcmVudFBvcnQucG9zdE1lc3NhZ2Uoe1xuXHRcdHRpbWVEaWZmOiBuZXcgRGF0ZSxcblx0XHRpbmRleDogbGluZU51bWJlcixcblx0XHRsaXN0LFxuXHR9KTtcblxufVxuXG5mdW5jdGlvbiBsb2coLi4uYXJndilcbntcblx0Y29uc29sZS5sb2coYFt0aHJlYWQ6JHt0aHJlYWRJZH1dYCwgLi4uYXJndik7XG59XG5cbmZ1bmN0aW9uIGdldENpZCh3OiBzdHJpbmcpXG57XG5cdHcgPSBVU3RyaW5nLnNsaWNlKHcsIDAsIDEpLnRvTG9jYWxlTG93ZXJDYXNlKCk7XG5cblx0aWYgKC9eW2EtejAtOV0kL2kudGVzdCh3KSlcblx0e1xuXHRcdHJldHVybiBFbnVtQzEuZW5nO1xuXHR9XG5cblx0bGV0IHMgPSBnZXRDamtOYW1lKHcpO1xuXG5cdGxldCByID0gc2x1Z2lmeVRyKHMpO1xuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIoZ3JlZWR5VGFibGVSZXBsYWNlKHMpKTtcblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdGxldCBhcnIgPSBsaWJUYWJsZS5hdXRvKHMsIHtcblx0XHRcdHNhZmU6IGZhbHNlLFxuXHRcdFx0Z3JlZWR5VGFibGU6IDIsXG5cdFx0fSk7XG5cblx0XHRpZiAoYXJyLmxlbmd0aClcblx0XHR7XG5cdFx0XHRyID0gc2x1Z2lmeVRyKGFyclsxXSB8fCBhcnJbMF0pO1xuXHRcdH1cblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdGxldCBhcnIgPSBsaWJUYWJsZS5hdXRvKHcsIHtcblx0XHRcdHNhZmU6IGZhbHNlLFxuXHRcdFx0Z3JlZWR5VGFibGU6IDIsXG5cdFx0fSk7XG5cblx0XHRpZiAoYXJyLmxlbmd0aClcblx0XHR7XG5cdFx0XHRyID0gc2x1Z2lmeVRyKGFyclsxXSB8fCBhcnJbMF0pO1xuXHRcdH1cblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIoY2prMnpocyhzKSk7XG5cdH1cblxuXHRpZiAoIXIpXG5cdHtcblx0XHRyID0gc2x1Z2lmeVRyKGNqazJ6aHQocykpO1xuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0ciA9IHNsdWdpZnlUcihjamsyemhzKHcpKTtcblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIoY2prMnpodCh3KSk7XG5cdH1cblxuXHRpZiAoIXIpXG5cdHtcblx0XHRyID0gc2x1Z2lmeVRyKHcpO1xuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0ciA9IHc7XG5cdH1cblxuXHRsZXQgcjIgPSBVU3RyaW5nLnNsaWNlKHIsIDAsIDEpO1xuXG5cdGlmICghL15bYS16MC05XSQvaS50ZXN0KHIyKSlcblx0e1xuXHRcdHIyID0gRW51bUMxLm90aGVyO1xuXHR9XG5cblx0cmV0dXJuIHIyLnRvTG9jYWxlTG93ZXJDYXNlKClcbn1cblxuZnVuY3Rpb24gU29ydExpc3Q8VCA9IElMb2FkRGljdEZpbGVSb3cyPihsczogVFtdKVxue1xuXHQvLyBAdHMtaWdub3JlXG5cdHJldHVybiBscy5zb3J0KGZ1bmN0aW9uIChhOiBJTG9hZERpY3RGaWxlUm93MiwgYjogSUxvYWREaWN0RmlsZVJvdzIpXG5cdHtcblx0XHRpZiAoXG5cdFx0XHRhLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVF9UQUdcblx0XHRcdHx8IGIubGluZV90eXBlID09IEVudW1MaW5lVHlwZS5DT01NRU5UX1RBR1xuXHRcdClcblx0XHR7XG5cdFx0XHRyZXR1cm4gKGEuaW5kZXggLSBiLmluZGV4KTtcblx0XHR9XG5cdFx0ZWxzZSBpZiAoXG5cdFx0XHRhLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVFxuXHRcdFx0fHwgYi5saW5lX3R5cGUgPT0gRW51bUxpbmVUeXBlLkNPTU1FTlRcblx0XHQpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIChhLmluZGV4IC0gYi5pbmRleCk7XG5cdFx0fVxuXG5cdFx0bGV0IHJldCA9IHpoRGljdENvbXBhcmUoYS5jamtfaWQsIGIuY2prX2lkKVxuXHRcdFx0fHwgKGEuaW5kZXggLSBiLmluZGV4KVxuXHRcdFx0fHwgMFxuXHRcdDtcblxuXHRcdHJldHVybiByZXQ7XG5cdH0pXG59XG4iXX0=