"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
const worker_threads_1 = require("worker_threads");
const lineByLine = require("n-readlines");
const project_config_1 = require("../project.config");
const path = require("upath2");
const index_1 = require("segment-dict/lib/loader/segment/index");
const uni_string_1 = require("uni-string");
const util_1 = require("@novel-segment/util");
const transliteration_1 = require("transliteration");
const fs = require("fs-extra");
const cjk_conv_1 = require("cjk-conv");
const fast_glob_1 = require("fast-glob");
const util_2 = require("segment-dict/script/util");
const array_hyper_unique_1 = require("array-hyper-unique");
const line_1 = require("segment-dict/lib/loader/line");
const debug_color2_1 = require("debug-color2");
const greedy_1 = require("cjk-conv/lib/zh/table/greedy");
const pinyin = require("pinyin");
const table_1 = require("cjk-conv/lib/zh/table");
const diff_staged_1 = require("@git-lazy/diff-staged");
const match_1 = require("@git-lazy/util/util/match");
let CWD = path.join(project_config_1.default.temp_root);
var EnumC1;
(function (EnumC1) {
    EnumC1["char"] = "char";
    EnumC1["other"] = "other";
    EnumC1["eng"] = "eng";
})(EnumC1 || (EnumC1 = {}));
const CWD_SAVETO = path.join(CWD, 'cache');
if (!fs.pathExistsSync(path.join(CWD, 'stringify.txt')) || !match_1.matchGlob(diff_staged_1.gitDiffStagedFile(CWD), [
    'cache.db.info.json'
]).length) {
    process.exit();
}
if (worker_threads_1.isMainThread) {
    log("This is the main thread", worker_threads_1.threadId);
    let workerOptions = {
        workerData: {
            time: new Date,
        },
    };
    let w1 = new worker_threads_1.Worker(__filename, workerOptions);
    //let w2 = new Worker(__filename, workerOptions);
    //	const subChannel = new MessageChannel();
    //
    //	w2.postMessage({
    //		hereIsYourPort: subChannel.port1
    //	}, [subChannel.port1]);
    //	w1.postMessage({
    //		hereIsYourPort: subChannel.port2
    //	}, [subChannel.port2]);
    let timeDiff;
    fs.removeSync(CWD_SAVETO);
    w1.on('message', (msg) => {
        timeDiff = msg.timeDiff;
        //console.dir(msg);
        log(msg.index, msg.list.length);
        let cache = {
            char: [],
            other: [],
            eng: [],
        };
        {
            let i = 'a'.codePointAt(0);
            let j = 'z'.codePointAt(0);
            while (i <= j) {
                cache[String.fromCodePoint(i)] = [];
                i++;
            }
        }
        cache = msg.list.reduce(function (cache, cur) {
            // @ts-ignore
            let { c1, line } = cur;
            cache[c1] = cache[c1] || [];
            cache[c1].push(Buffer.from(line).toString());
            return cache;
        }, cache);
        Object.entries(cache).forEach(async function ([c1, ls]) {
            if (!/^[a-z0-9]$/i.test(c1)) {
                c1 = '0/' + c1;
            }
            let file = path.join(CWD_SAVETO, c1 + '.txt');
            fs.ensureFileSync(file);
            if (!ls.length) {
                return;
            }
            return fs.appendFileSync(file, ls.join('\n') + '\n');
        });
        //fs.appendFile()
    });
    w1.on('error', debug_color2_1.console.error.bind(debug_color2_1.console));
    w1.on('exit', (code) => {
        let bool = true;
        try {
            let i = timeDiff.getTime() - workerOptions.workerData.time.getTime();
            log(i, timeDiff);
        }
        catch (e) {
            bool = false;
        }
        if (bool) {
            let ls = fast_glob_1.default.sync([
                '**/*.txt'
            ], {
                cwd: CWD_SAVETO,
                absolute: true,
            }).sort();
            let file2 = path.join(CWD, 'stringify.sorted.txt');
            fs.ensureFileSync(file2);
            fs.truncateSync(file2);
            let i2 = ls.reduce((a, file) => {
                log('[start]', path.relative(CWD_SAVETO, file));
                const liner = new lineByLine(file);
                let line;
                let index = 0;
                let list = [];
                while (line = liner.next()) {
                    let s = line.toString();
                    let data = index_1.parseLine(s);
                    let [w, p, f] = data;
                    let cur = {
                        // @ts-ignore
                        data,
                        line: s,
                        index: index++,
                        c1: "other" /* other */,
                        line_type: util_2.chkLineType(s),
                        cjk_id: util_1.getCjkName(w),
                    };
                    list.push(cur);
                    a++;
                }
                list = SortList(list);
                let out_list = list.map(v => v.line);
                out_list = array_hyper_unique_1.array_unique(out_list);
                let out_data = line_1.serialize(out_list);
                fs.outputFileSync(file, out_data + "\n\n");
                fs.appendFileSync(file2, out_data + "\n");
                log('[done]', path.relative(CWD_SAVETO, file));
                return a;
            }, 0);
            log(i2);
        }
        if (code != 0) {
            debug_color2_1.console.error(new Error(`Worker stopped with exit code ${code}`));
        }
        else {
            log(`Worker stopped`);
        }
    });
}
else {
    //	parentPort.once('message', (value) => {
    //		value.hereIsYourPort.postMessage('hello');
    //		value.hereIsYourPort.on('message', msg => {
    //			console.log(`thread ${threadId}: receive ${msg}`);
    //		});
    //	});
    //the worker's code
    debug_color2_1.console.dir(worker_threads_1.workerData, {
        colors: true,
    });
    //	log(workerData.re.test(' '));
    let file = path.join(CWD, 'stringify.txt');
    const liner = new lineByLine(file);
    let line;
    let lineNumber = 0;
    let count = 0;
    let c1_old;
    let list = [];
    while (line = liner.next()) {
        //console.log('Line ' + lineNumber + ': ' + line.toString('ascii'));
        let index = lineNumber++;
        let data = index_1.parseLine(line.toString());
        let cur = {
            data,
            line,
            index,
            c1: "other" /* other */,
        };
        let [w, p, f] = cur.data;
        let len = uni_string_1.default.size(w);
        let c1_now;
        if (len > 1) {
            c1_now = getCid(w);
            if (!c1_now) {
                debug_color2_1.console.log(c1_now, w);
                throw new Error(`${w}, ${c1_now}`);
            }
        }
        else if (len === 1) {
            c1_now = "char" /* char */;
        }
        else {
            c1_now = "other" /* other */;
        }
        cur.c1 = c1_now;
        if (count >= 10000) {
            worker_threads_1.parentPort.postMessage({
                index,
                list,
            });
            list = [];
            count = 0;
        }
        list.push(cur);
        c1_old = c1_now;
        count++;
    }
    log('end of line reached', lineNumber);
    worker_threads_1.workerData.count = lineNumber;
    worker_threads_1.parentPort.postMessage({
        timeDiff: new Date,
        index: lineNumber,
        list,
    });
}
function log(...argv) {
    debug_color2_1.console.log(`[thread:${worker_threads_1.threadId}]`, ...argv);
}
function getCid(w) {
    w = uni_string_1.default.slice(w, 0, 1).toLocaleLowerCase();
    if (/^[a-z0-9]$/i.test(w)) {
        return "eng" /* eng */;
    }
    let s = util_1.getCjkName(w);
    let r = transliteration_1.slugify(s);
    if (!r) {
        try {
            r = transliteration_1.slugify(pinyin(s)[0][0]);
        }
        catch (e) {
        }
    }
    if (!r) {
        try {
            r = transliteration_1.slugify(pinyin(w)[0][0]);
        }
        catch (e) {
        }
    }
    if (!r) {
        r = transliteration_1.slugify(greedy_1.greedyTableReplace(s));
    }
    if (!r) {
        let arr = table_1.default.auto(s, {
            safe: false,
            greedyTable: 2,
        });
        if (arr.length) {
            r = transliteration_1.slugify(arr[1] || arr[0]);
        }
    }
    if (!r) {
        let arr = table_1.default.auto(w, {
            safe: false,
            greedyTable: 2,
        });
        if (arr.length) {
            r = transliteration_1.slugify(arr[1] || arr[0]);
        }
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zhs(s));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zht(s));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zhs(w));
    }
    if (!r) {
        r = transliteration_1.slugify(cjk_conv_1.cjk2zht(w));
    }
    if (!r) {
        r = transliteration_1.slugify(w);
    }
    if (!r) {
        r = w;
    }
    let r2 = uni_string_1.default.slice(r, 0, 1);
    if (!/^[a-z0-9]$/i.test(r2)) {
        r2 = "other" /* other */;
    }
    return r2.toLocaleLowerCase();
}
function SortList(ls) {
    // @ts-ignore
    return ls.sort(function (a, b) {
        if (a.line_type == util_2.EnumLineType.COMMENT_TAG
            || b.line_type == util_2.EnumLineType.COMMENT_TAG) {
            return (a.index - b.index);
        }
        else if (a.line_type == util_2.EnumLineType.COMMENT
            || b.line_type == util_2.EnumLineType.COMMENT) {
            return (a.index - b.index);
        }
        let ret = util_1.zhDictCompare(a.cjk_id, b.cjk_id)
            || (a.index - b.index)
            || 0;
        return ret;
    });
}
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoic29ydC1zdHJpbmdpZnktY2FjaGUuanMiLCJzb3VyY2VSb290IjoiIiwic291cmNlcyI6WyJzb3J0LXN0cmluZ2lmeS1jYWNoZS50cyJdLCJuYW1lcyI6W10sIm1hcHBpbmdzIjoiOztBQUFBLG1EQVF3QjtBQUN4QiwwQ0FBMkM7QUFDM0Msc0RBQThDO0FBQzlDLCtCQUErQjtBQUMvQixpRUFBK0g7QUFDL0gsMkNBQWlDO0FBQ2pDLDhDQUFnRTtBQUNoRSxxREFBNEU7QUFDNUUsK0JBQWdDO0FBRWhDLHVDQUE0QztBQUU1Qyx5Q0FBaUM7QUFDakMsbURBQXdGO0FBQ3hGLDJEQUFrRDtBQUNsRCx1REFBeUQ7QUFDekQsK0NBQXVEO0FBQ3ZELHlEQUFrRTtBQUNsRSxpQ0FBa0M7QUFDbEMsaURBQTZDO0FBQzdDLHVEQUEwRDtBQUMxRCxxREFBc0Q7QUFFdEQsSUFBSSxHQUFHLEdBQUcsSUFBSSxDQUFDLElBQUksQ0FBQyx3QkFBYSxDQUFDLFNBQVMsQ0FBQyxDQUFDO0FBRTdDLElBQVcsTUFLVjtBQUxELFdBQVcsTUFBTTtJQUVoQix1QkFBYSxDQUFBO0lBQ2IseUJBQWUsQ0FBQTtJQUNmLHFCQUFXLENBQUE7QUFDWixDQUFDLEVBTFUsTUFBTSxLQUFOLE1BQU0sUUFLaEI7QUFFRCxNQUFNLFVBQVUsR0FBRyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxPQUFPLENBQUMsQ0FBQztBQUUzQyxJQUFJLENBQUMsRUFBRSxDQUFDLGNBQWMsQ0FBQyxJQUFJLENBQUMsSUFBSSxDQUFDLEdBQUcsRUFBRSxlQUFlLENBQUMsQ0FBQyxJQUFJLENBQUMsaUJBQVMsQ0FBQywrQkFBaUIsQ0FBQyxHQUFHLENBQUMsRUFBRTtJQUM3RixvQkFBb0I7Q0FDcEIsQ0FBQyxDQUFDLE1BQU0sRUFDVDtJQUNDLE9BQU8sQ0FBQyxJQUFJLEVBQUUsQ0FBQztDQUNmO0FBRUQsSUFBSSw2QkFBWSxFQUNoQjtJQUNDLEdBQUcsQ0FBQyx5QkFBeUIsRUFBRSx5QkFBUSxDQUFDLENBQUM7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QyxDQUFDLENBQUM7SUFFaEMsSUFBSSxDQUFDLGFBQWEsQ0FBQyxJQUFJLENBQUMsRUFBRSxDQUFDLEVBQzNCO1FBQ0MsRUFBRSxzQkFBZSxDQUFDO0tBQ2xCO0lBRUQsT0FBTyxFQUFFLENBQUMsaUJBQWlCLEVBQUUsQ0FBQTtBQUM5QixDQUFDO0FBRUQsU0FBUyxRQUFRLENBQXdCLEVBQU87SUFFL0MsYUFBYTtJQUNiLE9BQU8sRUFBRSxDQUFDLElBQUksQ0FBQyxVQUFVLENBQW9CLEVBQUUsQ0FBb0I7UUFFbEUsSUFDQyxDQUFDLENBQUMsU0FBUyxJQUFJLG1CQUFZLENBQUMsV0FBVztlQUNwQyxDQUFDLENBQUMsU0FBUyxJQUFJLG1CQUFZLENBQUMsV0FBVyxFQUUzQztZQUNDLE9BQU8sQ0FBQyxDQUFDLENBQUMsS0FBSyxHQUFHLENBQUMsQ0FBQyxLQUFLLENBQUMsQ0FBQztTQUMzQjthQUNJLElBQ0osQ0FBQyxDQUFDLFNBQVMsSUFBSSxtQkFBWSxDQUFDLE9BQU87ZUFDaEMsQ0FBQyxDQUFDLFNBQVMsSUFBSSxtQkFBWSxDQUFDLE9BQU8sRUFFdkM7WUFDQyxPQUFPLENBQUMsQ0FBQyxDQUFDLEtBQUssR0FBRyxDQUFDLENBQUMsS0FBSyxDQUFDLENBQUM7U0FDM0I7UUFFRCxJQUFJLEdBQUcsR0FBRyxvQkFBYSxDQUFDLENBQUMsQ0FBQyxNQUFNLEVBQUUsQ0FBQyxDQUFDLE1BQU0sQ0FBQztlQUN2QyxDQUFDLENBQUMsQ0FBQyxLQUFLLEdBQUcsQ0FBQyxDQUFDLEtBQUssQ0FBQztlQUNuQixDQUFDLENBQ0o7UUFFRCxPQUFPLEdBQUcsQ0FBQztJQUNaLENBQUMsQ0FBQyxDQUFBO0FBQ0gsQ0FBQyIsInNvdXJjZXNDb250ZW50IjpbImltcG9ydCB7XG5cdFdvcmtlcixcblx0aXNNYWluVGhyZWFkLFxuXHRwYXJlbnRQb3J0LFxuXHR3b3JrZXJEYXRhLFxuXHR0aHJlYWRJZCxcblx0TWVzc2FnZUNoYW5uZWwsXG5cdE1lc3NhZ2VQb3J0LFxufSBmcm9tICd3b3JrZXJfdGhyZWFkcyc7XG5pbXBvcnQgbGluZUJ5TGluZSA9IHJlcXVpcmUoJ24tcmVhZGxpbmVzJyk7XG5pbXBvcnQgUHJvamVjdENvbmZpZyBmcm9tICcuLi9wcm9qZWN0LmNvbmZpZyc7XG5pbXBvcnQgKiBhcyBwYXRoIGZyb20gXCJ1cGF0aDJcIjtcbmltcG9ydCB7IElEaWN0Um93LCBwYXJzZUxpbmUgYXMgcGFyc2VMaW5lU2VnbWVudCwgc2VyaWFsaXplIGFzIHNlcmlhbGl6ZVNlZ21lbnQgfSBmcm9tICdzZWdtZW50LWRpY3QvbGliL2xvYWRlci9zZWdtZW50L2luZGV4JztcbmltcG9ydCBVU3RyaW5nIGZyb20gJ3VuaS1zdHJpbmcnO1xuaW1wb3J0IHsgZ2V0Q2prTmFtZSwgemhEaWN0Q29tcGFyZSB9IGZyb20gJ0Bub3ZlbC1zZWdtZW50L3V0aWwnO1xuaW1wb3J0IHsgdHJhbnNsaXRlcmF0ZSBhcyB0ciwgc2x1Z2lmeSBhcyBzbHVnaWZ5VHIgfSBmcm9tICd0cmFuc2xpdGVyYXRpb24nO1xuaW1wb3J0IGZzID0gcmVxdWlyZSgnZnMtZXh0cmEnKTtcbmltcG9ydCBCbHVlYmlyZCA9IHJlcXVpcmUoJ2JsdWViaXJkJyk7XG5pbXBvcnQgeyBjamsyemhzLCBjamsyemh0IH0gZnJvbSAnY2prLWNvbnYnO1xuaW1wb3J0IFN0clV0aWwgPSByZXF1aXJlKCdzdHItdXRpbCcpO1xuaW1wb3J0IEZhc3RHbG9iIGZyb20gJ2Zhc3QtZ2xvYic7XG5pbXBvcnQgeyBjaGtMaW5lVHlwZSwgRW51bUxpbmVUeXBlLCBJTG9hZERpY3RGaWxlUm93MiB9IGZyb20gJ3NlZ21lbnQtZGljdC9zY3JpcHQvdXRpbCc7XG5pbXBvcnQgeyBhcnJheV91bmlxdWUgfSBmcm9tICdhcnJheS1oeXBlci11bmlxdWUnO1xuaW1wb3J0IHsgc2VyaWFsaXplIH0gZnJvbSAnc2VnbWVudC1kaWN0L2xpYi9sb2FkZXIvbGluZSc7XG5pbXBvcnQgeyBjb25zb2xlLCBjaGFsa0J5Q29uc29sZSB9IGZyb20gJ2RlYnVnLWNvbG9yMic7XG5pbXBvcnQgeyBncmVlZHlUYWJsZVJlcGxhY2UgfSBmcm9tICdjamstY29udi9saWIvemgvdGFibGUvZ3JlZWR5JztcbmltcG9ydCBwaW55aW4gPSByZXF1aXJlKFwicGlueWluXCIpO1xuaW1wb3J0IGxpYlRhYmxlIGZyb20gJ2Nqay1jb252L2xpYi96aC90YWJsZSc7XG5pbXBvcnQgeyBnaXREaWZmU3RhZ2VkRmlsZSB9IGZyb20gJ0BnaXQtbGF6eS9kaWZmLXN0YWdlZCc7XG5pbXBvcnQgeyBtYXRjaEdsb2IgfSBmcm9tICdAZ2l0LWxhenkvdXRpbC91dGlsL21hdGNoJztcblxubGV0IENXRCA9IHBhdGguam9pbihQcm9qZWN0Q29uZmlnLnRlbXBfcm9vdCk7XG5cbmNvbnN0IGVudW0gRW51bUMxXG57XG5cdGNoYXIgPSAnY2hhcicsXG5cdG90aGVyID0gJ290aGVyJyxcblx0ZW5nID0gJ2VuZycsXG59XG5cbmNvbnN0IENXRF9TQVZFVE8gPSBwYXRoLmpvaW4oQ1dELCAnY2FjaGUnKTtcblxuaWYgKCFmcy5wYXRoRXhpc3RzU3luYyhwYXRoLmpvaW4oQ1dELCAnc3RyaW5naWZ5LnR4dCcpKSB8fCAhbWF0Y2hHbG9iKGdpdERpZmZTdGFnZWRGaWxlKENXRCksIFtcblx0J2NhY2hlLmRiLmluZm8uanNvbidcbl0pLmxlbmd0aClcbntcblx0cHJvY2Vzcy5leGl0KCk7XG59XG5cbmlmIChpc01haW5UaHJlYWQpXG57XG5cdGxvZyhcIlRoaXMgaXMgdGhlIG1haW4gdGhyZWFkXCIsIHRocmVhZElkKTtcblxuXHRsZXQgd29ya2VyT3B0aW9ucyA9IHtcblx0XHR3b3JrZXJEYXRhOiB7XG5cdFx0XHR0aW1lOiBuZXcgRGF0ZSxcblx0XHRcdC8vY291bnQ6IDAsXG5cdFx0XHQvL3JlOiAvICAgL2lnLFxuXHRcdH0sXG5cdH07XG5cblx0bGV0IHcxID0gbmV3IFdvcmtlcihfX2ZpbGVuYW1lLCB3b3JrZXJPcHRpb25zKTtcblx0Ly9sZXQgdzIgPSBuZXcgV29ya2VyKF9fZmlsZW5hbWUsIHdvcmtlck9wdGlvbnMpO1xuXG4vL1x0Y29uc3Qgc3ViQ2hhbm5lbCA9IG5ldyBNZXNzYWdlQ2hhbm5lbCgpO1xuLy9cbi8vXHR3Mi5wb3N0TWVzc2FnZSh7XG4vL1x0XHRoZXJlSXNZb3VyUG9ydDogc3ViQ2hhbm5lbC5wb3J0MVxuLy9cdH0sIFtzdWJDaGFubmVsLnBvcnQxXSk7XG4vL1x0dzEucG9zdE1lc3NhZ2Uoe1xuLy9cdFx0aGVyZUlzWW91clBvcnQ6IHN1YkNoYW5uZWwucG9ydDJcbi8vXHR9LCBbc3ViQ2hhbm5lbC5wb3J0Ml0pO1xuXG5cdGxldCB0aW1lRGlmZjogRGF0ZTtcblxuXHRmcy5yZW1vdmVTeW5jKENXRF9TQVZFVE8pO1xuXG5cdHcxLm9uKCdtZXNzYWdlJywgKG1zZykgPT5cblx0e1xuXG5cdFx0dGltZURpZmYgPSBtc2cudGltZURpZmY7XG5cblx0XHQvL2NvbnNvbGUuZGlyKG1zZyk7XG5cblx0XHRsb2cobXNnLmluZGV4LCBtc2cubGlzdC5sZW5ndGgpO1xuXG5cdFx0bGV0IGNhY2hlID0ge1xuXHRcdFx0Y2hhcjogW10sXG5cdFx0XHRvdGhlcjogW10sXG5cdFx0XHRlbmc6IFtdLFxuXHRcdH0gYXMge1xuXHRcdFx0W2sgaW4gRW51bUMxIHwgc3RyaW5nXTogc3RyaW5nW107XG5cdFx0fTtcblxuXHRcdHtcblx0XHRcdGxldCBpID0gJ2EnLmNvZGVQb2ludEF0KDApO1xuXHRcdFx0bGV0IGogPSAneicuY29kZVBvaW50QXQoMCk7XG5cblx0XHRcdHdoaWxlIChpIDw9IGopXG5cdFx0XHR7XG5cdFx0XHRcdGNhY2hlW1N0cmluZy5mcm9tQ29kZVBvaW50KGkpXSA9IFtdO1xuXG5cdFx0XHRcdGkrKztcblx0XHRcdH1cblx0XHR9XG5cblx0XHRjYWNoZSA9IG1zZy5saXN0LnJlZHVjZShmdW5jdGlvbiAoY2FjaGUsIGN1cilcblx0XHR7XG5cblx0XHRcdC8vIEB0cy1pZ25vcmVcblx0XHRcdGxldCB7IGMxLCBsaW5lIH0gPSBjdXI7XG5cblx0XHRcdGNhY2hlW2MxXSA9IGNhY2hlW2MxXSB8fCBbXTtcblxuXHRcdFx0Y2FjaGVbYzFdLnB1c2goQnVmZmVyLmZyb20obGluZSkudG9TdHJpbmcoKSk7XG5cblx0XHRcdHJldHVybiBjYWNoZVxuXHRcdH0sIGNhY2hlKVxuXHRcdDtcblxuXHRcdE9iamVjdC5lbnRyaWVzKGNhY2hlKS5mb3JFYWNoKGFzeW5jIGZ1bmN0aW9uIChbYzEsIGxzXSlcblx0XHR7XG5cdFx0XHRpZiAoIS9eW2EtejAtOV0kL2kudGVzdChjMSkpXG5cdFx0XHR7XG5cdFx0XHRcdGMxID0gJzAvJyArIGMxO1xuXHRcdFx0fVxuXG5cdFx0XHRsZXQgZmlsZSA9IHBhdGguam9pbihDV0RfU0FWRVRPLCBjMSArICcudHh0Jyk7XG5cblx0XHRcdGZzLmVuc3VyZUZpbGVTeW5jKGZpbGUpO1xuXG5cdFx0XHRpZiAoIWxzLmxlbmd0aClcblx0XHRcdHtcblx0XHRcdFx0cmV0dXJuO1xuXHRcdFx0fVxuXG5cdFx0XHRyZXR1cm4gZnMuYXBwZW5kRmlsZVN5bmMoZmlsZSwgbHMuam9pbignXFxuJykgKyAnXFxuJylcblx0XHR9KTtcblxuXHRcdC8vZnMuYXBwZW5kRmlsZSgpXG5cblx0fSk7XG5cblx0dzEub24oJ2Vycm9yJywgY29uc29sZS5lcnJvci5iaW5kKGNvbnNvbGUpKTtcblx0dzEub24oJ2V4aXQnLCAoY29kZSkgPT5cblx0e1xuXG5cdFx0bGV0IGJvb2wgPSB0cnVlO1xuXG5cdFx0dHJ5XG5cdFx0e1xuXHRcdFx0bGV0IGkgPSB0aW1lRGlmZi5nZXRUaW1lKCkgLSB3b3JrZXJPcHRpb25zLndvcmtlckRhdGEudGltZS5nZXRUaW1lKCk7XG5cblx0XHRcdGxvZyhpLCB0aW1lRGlmZik7XG5cdFx0fVxuXHRcdGNhdGNoIChlKVxuXHRcdHtcblx0XHRcdGJvb2wgPSBmYWxzZTtcblx0XHR9XG5cblx0XHRpZiAoYm9vbClcblx0XHR7XG5cdFx0XHRsZXQgbHMgPSBGYXN0R2xvYi5zeW5jPHN0cmluZz4oW1xuXHRcdFx0XHQnKiovKi50eHQnXG5cdFx0XHRdLCB7XG5cdFx0XHRcdGN3ZDogQ1dEX1NBVkVUTyxcblx0XHRcdFx0YWJzb2x1dGU6IHRydWUsXG5cdFx0XHR9KS5zb3J0KCk7XG5cblx0XHRcdGxldCBmaWxlMiA9IHBhdGguam9pbihDV0QsICdzdHJpbmdpZnkuc29ydGVkLnR4dCcpO1xuXG5cdFx0XHRmcy5lbnN1cmVGaWxlU3luYyhmaWxlMik7XG5cdFx0XHRmcy50cnVuY2F0ZVN5bmMoZmlsZTIpO1xuXG5cdFx0XHRsZXQgaTIgPSBscy5yZWR1Y2UoKGEsIGZpbGU6IHN0cmluZykgPT4ge1xuXG5cdFx0XHRcdGxvZygnW3N0YXJ0XScsIHBhdGgucmVsYXRpdmUoQ1dEX1NBVkVUTywgZmlsZSkpO1xuXG5cdFx0XHRcdGNvbnN0IGxpbmVyID0gbmV3IGxpbmVCeUxpbmUoZmlsZSk7XG5cdFx0XHRcdGxldCBsaW5lOiBCdWZmZXI7XG5cblx0XHRcdFx0bGV0IGluZGV4ID0gMDtcblxuXHRcdFx0XHRsZXQgbGlzdDogSUxvYWREaWN0RmlsZVJvdzJbXSA9IFtdO1xuXG5cdFx0XHRcdHdoaWxlIChsaW5lID0gbGluZXIubmV4dCgpKVxuXHRcdFx0XHR7XG5cdFx0XHRcdFx0bGV0IHMgPSBsaW5lLnRvU3RyaW5nKCk7XG5cdFx0XHRcdFx0bGV0IGRhdGEgPSBwYXJzZUxpbmVTZWdtZW50KHMpO1xuXHRcdFx0XHRcdGxldCBbdywgcCwgZl0gPSBkYXRhO1xuXG5cdFx0XHRcdFx0bGV0IGN1cjogSUxvYWREaWN0RmlsZVJvdzIgPSB7XG5cdFx0XHRcdFx0XHQvLyBAdHMtaWdub3JlXG5cdFx0XHRcdFx0XHRkYXRhLFxuXHRcdFx0XHRcdFx0bGluZTogcyxcblx0XHRcdFx0XHRcdGluZGV4OiBpbmRleCsrLFxuXHRcdFx0XHRcdFx0YzE6IEVudW1DMS5vdGhlciBhcyBzdHJpbmcsXG5cdFx0XHRcdFx0XHRsaW5lX3R5cGU6IGNoa0xpbmVUeXBlKHMpLFxuXHRcdFx0XHRcdFx0Y2prX2lkOiBnZXRDamtOYW1lKHcpLFxuXHRcdFx0XHRcdH07XG5cblx0XHRcdFx0XHRsaXN0LnB1c2goY3VyKTtcblxuXHRcdFx0XHRcdGErKztcblx0XHRcdFx0fVxuXG5cdFx0XHRcdGxpc3QgPSBTb3J0TGlzdCggbGlzdCk7XG5cblx0XHRcdFx0bGV0IG91dF9saXN0ID0gbGlzdC5tYXAodiA9PiB2LmxpbmUpO1xuXG5cdFx0XHRcdG91dF9saXN0ID0gYXJyYXlfdW5pcXVlKG91dF9saXN0KTtcblxuXHRcdFx0XHRsZXQgb3V0X2RhdGEgPSBzZXJpYWxpemUob3V0X2xpc3QpO1xuXG5cdFx0XHRcdGZzLm91dHB1dEZpbGVTeW5jKGZpbGUsIG91dF9kYXRhICsgXCJcXG5cXG5cIik7XG5cblx0XHRcdFx0ZnMuYXBwZW5kRmlsZVN5bmMoZmlsZTIsIG91dF9kYXRhICsgXCJcXG5cIik7XG5cblx0XHRcdFx0bG9nKCdbZG9uZV0nLCBwYXRoLnJlbGF0aXZlKENXRF9TQVZFVE8sIGZpbGUpKTtcblxuXHRcdFx0XHRyZXR1cm4gYTtcblx0XHRcdH0sIDApO1xuXG5cdFx0XHRsb2coaTIpXG5cdFx0fVxuXG5cdFx0aWYgKGNvZGUgIT0gMClcblx0XHR7XG5cdFx0XHRjb25zb2xlLmVycm9yKG5ldyBFcnJvcihgV29ya2VyIHN0b3BwZWQgd2l0aCBleGl0IGNvZGUgJHtjb2RlfWApKVxuXHRcdH1cblx0XHRlbHNlXG5cdFx0e1xuXHRcdFx0bG9nKGBXb3JrZXIgc3RvcHBlZGApXG5cdFx0fVxuXHR9KTtcblxufVxuZWxzZVxue1xuLy9cdHBhcmVudFBvcnQub25jZSgnbWVzc2FnZScsICh2YWx1ZSkgPT4ge1xuLy9cdFx0dmFsdWUuaGVyZUlzWW91clBvcnQucG9zdE1lc3NhZ2UoJ2hlbGxvJyk7XG4vL1x0XHR2YWx1ZS5oZXJlSXNZb3VyUG9ydC5vbignbWVzc2FnZScsIG1zZyA9PiB7XG4vL1x0XHRcdGNvbnNvbGUubG9nKGB0aHJlYWQgJHt0aHJlYWRJZH06IHJlY2VpdmUgJHttc2d9YCk7XG4vL1x0XHR9KTtcbi8vXHR9KTtcblxuXHQvL3RoZSB3b3JrZXIncyBjb2RlXG5cblx0Y29uc29sZS5kaXIod29ya2VyRGF0YSwge1xuXHRcdGNvbG9yczogdHJ1ZSxcblx0fSk7XG5cbi8vXHRsb2cod29ya2VyRGF0YS5yZS50ZXN0KCcgJykpO1xuXG5cdGxldCBmaWxlID0gcGF0aC5qb2luKENXRCwgJ3N0cmluZ2lmeS50eHQnKTtcblxuXHRjb25zdCBsaW5lciA9IG5ldyBsaW5lQnlMaW5lKGZpbGUpO1xuXG5cdGxldCBsaW5lOiBCdWZmZXI7XG5cdGxldCBsaW5lTnVtYmVyID0gMDtcblx0bGV0IGNvdW50ID0gMDtcblxuXHRsZXQgYzFfb2xkOiBzdHJpbmc7XG5cblx0bGV0IGxpc3QgPSBbXTtcblxuXHR3aGlsZSAobGluZSA9IGxpbmVyLm5leHQoKSlcblx0e1xuXHRcdC8vY29uc29sZS5sb2coJ0xpbmUgJyArIGxpbmVOdW1iZXIgKyAnOiAnICsgbGluZS50b1N0cmluZygnYXNjaWknKSk7XG5cblx0XHRsZXQgaW5kZXggPSBsaW5lTnVtYmVyKys7XG5cblx0XHRsZXQgZGF0YSA9IHBhcnNlTGluZVNlZ21lbnQobGluZS50b1N0cmluZygpKTtcblxuXHRcdGxldCBjdXIgPSB7XG5cdFx0XHRkYXRhLFxuXHRcdFx0bGluZSxcblx0XHRcdGluZGV4LFxuXHRcdFx0YzE6IEVudW1DMS5vdGhlciBhcyBzdHJpbmcsXG5cdFx0fTtcblxuXHRcdGxldCBbdywgcCwgZl0gPSBjdXIuZGF0YTtcblxuXHRcdGxldCBsZW4gPSBVU3RyaW5nLnNpemUodyk7XG5cblx0XHRsZXQgYzFfbm93OiBzdHJpbmc7XG5cblx0XHRpZiAobGVuID4gMSlcblx0XHR7XG5cdFx0XHRjMV9ub3cgPSBnZXRDaWQodyk7XG5cblx0XHRcdGlmICghYzFfbm93KVxuXHRcdFx0e1xuXHRcdFx0XHRjb25zb2xlLmxvZyhjMV9ub3csIHcpO1xuXG5cdFx0XHRcdHRocm93IG5ldyBFcnJvcihgJHt3fSwgJHtjMV9ub3d9YCk7XG5cdFx0XHR9XG5cdFx0fVxuXHRcdGVsc2UgaWYgKGxlbiA9PT0gMSlcblx0XHR7XG5cdFx0XHRjMV9ub3cgPSBFbnVtQzEuY2hhcjtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdGMxX25vdyA9IEVudW1DMS5vdGhlcjtcblx0XHR9XG5cblx0XHRjdXIuYzEgPSBjMV9ub3c7XG5cblx0XHRpZiAoY291bnQgPj0gMTAwMDApXG5cdFx0e1xuXHRcdFx0cGFyZW50UG9ydC5wb3N0TWVzc2FnZSh7XG5cblx0XHRcdFx0aW5kZXgsXG5cdFx0XHRcdGxpc3QsXG5cblx0XHRcdH0pO1xuXG5cdFx0XHRsaXN0ID0gW107XG5cblx0XHRcdGNvdW50ID0gMDtcblx0XHR9XG5cblx0XHRsaXN0LnB1c2goY3VyKTtcblxuXHRcdGMxX29sZCA9IGMxX25vdztcblxuXHRcdGNvdW50Kys7XG5cdH1cblxuXHRsb2coJ2VuZCBvZiBsaW5lIHJlYWNoZWQnLCBsaW5lTnVtYmVyKTtcblxuXHR3b3JrZXJEYXRhLmNvdW50ID0gbGluZU51bWJlcjtcblxuXHRwYXJlbnRQb3J0LnBvc3RNZXNzYWdlKHtcblx0XHR0aW1lRGlmZjogbmV3IERhdGUsXG5cdFx0aW5kZXg6IGxpbmVOdW1iZXIsXG5cdFx0bGlzdCxcblx0fSk7XG5cbn1cblxuZnVuY3Rpb24gbG9nKC4uLmFyZ3YpXG57XG5cdGNvbnNvbGUubG9nKGBbdGhyZWFkOiR7dGhyZWFkSWR9XWAsIC4uLmFyZ3YpO1xufVxuXG5mdW5jdGlvbiBnZXRDaWQodzogc3RyaW5nKVxue1xuXHR3ID0gVVN0cmluZy5zbGljZSh3LCAwLCAxKS50b0xvY2FsZUxvd2VyQ2FzZSgpO1xuXG5cdGlmICgvXlthLXowLTldJC9pLnRlc3QodykpXG5cdHtcblx0XHRyZXR1cm4gRW51bUMxLmVuZztcblx0fVxuXG5cdGxldCBzID0gZ2V0Q2prTmFtZSh3KTtcblxuXHRsZXQgciA9IHNsdWdpZnlUcihzKTtcblxuXHRpZiAoIXIpXG5cdHtcblx0XHR0cnlcblx0XHR7XG5cdFx0XHRyID0gc2x1Z2lmeVRyKHBpbnlpbihzKVswXVswXSk7XG5cdFx0fVxuXHRcdGNhdGNoIChlKVxuXHRcdHtcblxuXHRcdH1cblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHRyeVxuXHRcdHtcblx0XHRcdHIgPSBzbHVnaWZ5VHIocGlueWluKHcpWzBdWzBdKTtcblx0XHR9XG5cdFx0Y2F0Y2ggKGUpXG5cdFx0e1xuXG5cdFx0fVxuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0ciA9IHNsdWdpZnlUcihncmVlZHlUYWJsZVJlcGxhY2UocykpO1xuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0bGV0IGFyciA9IGxpYlRhYmxlLmF1dG8ocywge1xuXHRcdFx0c2FmZTogZmFsc2UsXG5cdFx0XHRncmVlZHlUYWJsZTogMixcblx0XHR9KTtcblxuXHRcdGlmIChhcnIubGVuZ3RoKVxuXHRcdHtcblx0XHRcdHIgPSBzbHVnaWZ5VHIoYXJyWzFdIHx8IGFyclswXSk7XG5cdFx0fVxuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0bGV0IGFyciA9IGxpYlRhYmxlLmF1dG8odywge1xuXHRcdFx0c2FmZTogZmFsc2UsXG5cdFx0XHRncmVlZHlUYWJsZTogMixcblx0XHR9KTtcblxuXHRcdGlmIChhcnIubGVuZ3RoKVxuXHRcdHtcblx0XHRcdHIgPSBzbHVnaWZ5VHIoYXJyWzFdIHx8IGFyclswXSk7XG5cdFx0fVxuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0ciA9IHNsdWdpZnlUcihjamsyemhzKHMpKTtcblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIoY2prMnpodChzKSk7XG5cdH1cblxuXHRpZiAoIXIpXG5cdHtcblx0XHRyID0gc2x1Z2lmeVRyKGNqazJ6aHModykpO1xuXHR9XG5cblx0aWYgKCFyKVxuXHR7XG5cdFx0ciA9IHNsdWdpZnlUcihjamsyemh0KHcpKTtcblx0fVxuXG5cdGlmICghcilcblx0e1xuXHRcdHIgPSBzbHVnaWZ5VHIodyk7XG5cdH1cblxuXHRpZiAoIXIpXG5cdHtcblx0XHRyID0gdztcblx0fVxuXG5cdGxldCByMiA9IFVTdHJpbmcuc2xpY2UociwgMCwgMSk7XG5cblx0aWYgKCEvXlthLXowLTldJC9pLnRlc3QocjIpKVxuXHR7XG5cdFx0cjIgPSBFbnVtQzEub3RoZXI7XG5cdH1cblxuXHRyZXR1cm4gcjIudG9Mb2NhbGVMb3dlckNhc2UoKVxufVxuXG5mdW5jdGlvbiBTb3J0TGlzdDxUID0gSUxvYWREaWN0RmlsZVJvdzI+KGxzOiBUW10pXG57XG5cdC8vIEB0cy1pZ25vcmVcblx0cmV0dXJuIGxzLnNvcnQoZnVuY3Rpb24gKGE6IElMb2FkRGljdEZpbGVSb3cyLCBiOiBJTG9hZERpY3RGaWxlUm93Milcblx0e1xuXHRcdGlmIChcblx0XHRcdGEubGluZV90eXBlID09IEVudW1MaW5lVHlwZS5DT01NRU5UX1RBR1xuXHRcdFx0fHwgYi5saW5lX3R5cGUgPT0gRW51bUxpbmVUeXBlLkNPTU1FTlRfVEFHXG5cdFx0KVxuXHRcdHtcblx0XHRcdHJldHVybiAoYS5pbmRleCAtIGIuaW5kZXgpO1xuXHRcdH1cblx0XHRlbHNlIGlmIChcblx0XHRcdGEubGluZV90eXBlID09IEVudW1MaW5lVHlwZS5DT01NRU5UXG5cdFx0XHR8fCBiLmxpbmVfdHlwZSA9PSBFbnVtTGluZVR5cGUuQ09NTUVOVFxuXHRcdClcblx0XHR7XG5cdFx0XHRyZXR1cm4gKGEuaW5kZXggLSBiLmluZGV4KTtcblx0XHR9XG5cblx0XHRsZXQgcmV0ID0gemhEaWN0Q29tcGFyZShhLmNqa19pZCwgYi5jamtfaWQpXG5cdFx0XHR8fCAoYS5pbmRleCAtIGIuaW5kZXgpXG5cdFx0XHR8fCAwXG5cdFx0O1xuXG5cdFx0cmV0dXJuIHJldDtcblx0fSlcbn1cbiJdfQ==