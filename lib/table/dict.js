"use strict";
Object.defineProperty(exports, "__esModule", { value: true });
exports.TableDict = void 0;
const segment_1 = require("segment-dict/lib/loader/segment");
const cjk_1 = require("../util/cjk");
const core_1 = require("./core");
const util_1 = require("../util");
/**
 * @todo 掛接其他 dict
 */
class TableDict extends core_1.default {
    constructor() {
        super(...arguments);
        this.TABLE = {};
        this.TABLE2 = {};
    }
    exists(data) {
        let w, p, f;
        if (typeof data == 'string') {
            w = data;
        }
        else if (Array.isArray(data)) {
            [w, p, f] = data;
        }
        else {
            ({ w, p, f } = data);
        }
        return this.TABLE[w] || null;
    }
    __handleInput(data) {
        let w, p, f;
        let plus;
        if (typeof data == 'string') {
            w = data;
        }
        else if (Array.isArray(data)) {
            [w, p, f, ...plus] = data;
        }
        else {
            ({ w, p, f } = data);
        }
        if (typeof w !== 'string' || w === '') {
            throw new TypeError(JSON.stringify(data));
        }
        p = (typeof p != 'number' || Number.isNaN(p)) ? 0 : p;
        f = (typeof f != 'number' || Number.isNaN(f)) ? 0 : f;
        return {
            data: {
                w, p, f,
            },
            plus,
        };
    }
    add(data, skipExists) {
        let w, p, f;
        let plus;
        {
            let ret = this.__handleInput(data);
            ({ w, p, f } = ret.data);
            plus = ret.plus;
        }
        if (skipExists && this.exists(w)) {
            return this;
        }
        if (plus && plus.length) {
            // @todo do something
        }
        this._add({ w, p, f, s: true });
        let self = this;
        /**
         * @todo 需要更聰明的作法 目前的做法實在太蠢
         * @BUG 在不明原因下 似乎不會正確的添加每個項目 如果遇到這種情形請手動添加簡繁項目
         */
        if (1 && this.options.autoCjk) {
            let wa = cjk_1.text_list(w);
            wa.forEach(function (w2) {
                if (w2 != w && !self.exists(w2)) {
                    self._add({ w: w2, p, f });
                }
            });
            /*
            let w2: string;
            w2 = CjkConv.zh2jp(w);

            if (w2 != w && !this.exists(w2))
            {
                this._add({w: w2, p, f});
                //console.log(w2);
            }

            w2 = CjkConv.cjk2zht(w);

            if (w2 !== w && !this.exists(w2))
            {
                this._add({w: w2, p, f});
                //console.log(w2);
            }

            w2 = CjkConv.cjk2zhs(w);

            if (w2 !== w && !this.exists(w2))
            {
                this._add({w: w2, p, f});
                //console.log(w2);
            }
            */
        }
        return this;
    }
    _add({ w, p, f, s }) {
        let len = w.length;
        this.TABLE[w] = {
            p,
            f,
            s,
        };
        if (!this.TABLE2[len])
            this.TABLE2[len] = {};
        this.TABLE2[len][w] = this.TABLE[w];
    }
    remove(target) {
        let { data, plus } = this.__handleInput(target);
        this._remove(data);
        return this;
    }
    _remove({ w, p, f, s }) {
        let len = w.length;
        delete this.TABLE[w];
        if (this.TABLE2[len]) {
            delete this.TABLE2[len][w];
        }
        return this;
    }
    json() {
        return util_1.cloneDeep(this.TABLE);
    }
    /**
     * 將目前的 表格 匯出
     */
    stringify(LF = "\n") {
        let self = this;
        return Object.entries(self.TABLE)
            .reduce(function (a, [w, { p, f }]) {
            let line = segment_1.stringifyLine([w, p, f]);
            a.push(line);
            return a;
        }, [])
            .join(typeof LF === 'string' ? LF : "\n");
    }
}
exports.TableDict = TableDict;
exports.default = TableDict;
//# sourceMappingURL=data:application/json;base64,eyJ2ZXJzaW9uIjozLCJmaWxlIjoiZGljdC5qcyIsInNvdXJjZVJvb3QiOiIiLCJzb3VyY2VzIjpbImRpY3QudHMiXSwibmFtZXMiOltdLCJtYXBwaW5ncyI6Ijs7O0FBSUEsNkRBQXFGO0FBRXJGLHFDQUF3QztBQUN4QyxpQ0FBd0U7QUFDeEUsa0NBQW9DO0FBWXBDOztHQUVHO0FBQ0gsTUFBYSxTQUFVLFNBQVEsY0FBb0M7SUFBbkU7O1FBSUMsVUFBSyxHQUF5QixFQUFFLENBQUM7UUFDakMsV0FBTSxHQUEwQixFQUFFLENBQUM7SUFxTXBDLENBQUM7SUFqTUEsTUFBTSxDQUFDLElBQStCO1FBRXJDLElBQUksQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLENBQUM7UUFFWixJQUFJLE9BQU8sSUFBSSxJQUFJLFFBQVEsRUFDM0I7WUFDQyxDQUFDLEdBQUcsSUFBSSxDQUFDO1NBQ1Q7YUFDSSxJQUFJLEtBQUssQ0FBQyxPQUFPLENBQUMsSUFBSSxDQUFDLEVBQzVCO1lBQ0MsQ0FBQyxDQUFDLEVBQUUsQ0FBQyxFQUFFLENBQUMsQ0FBQyxHQUFHLElBQUksQ0FBQztTQUNqQjthQUVEO1lBQ0MsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsQ0FBQyxFQUFFLEdBQUcsSUFBSSxDQUFDLENBQUM7U0FDckI7UUFFRCxPQUFPLElBQUksQ0FBQyxLQUFLLENBQUMsQ0FBQyxDQUFDLElBQUksSUFBSSxDQUFDO0lBQzlCLENBQUM7SUFFUyxhQUFhLENBQUMsSUFBK0I7UUFFdEQsSUFBSSxDQUFTLEVBQUUsQ0FBUyxFQUFFLENBQVMsQ0FBQztRQUNwQyxJQUFJLElBQTRCLENBQUM7UUFFakMsSUFBSSxPQUFPLElBQUksSUFBSSxRQUFRLEVBQzNCO1lBQ0MsQ0FBQyxHQUFHLElBQUksQ0FBQztTQUNUO2FBQ0ksSUFBSSxLQUFLLENBQUMsT0FBTyxDQUFDLElBQUksQ0FBQyxFQUM1QjtZQUNDLENBQUMsQ0FBQyxFQUFFLENBQUMsRUFBRSxDQUFDLEVBQUUsR0FBRyxJQUFJLENBQUMsR0FBRyxJQUFJLENBQUM7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QyxDQUFDO1lBRWIsT0FBTyxDQUFDLENBQUE7UUFDVCxDQUFDLEVBQUUsRUFBRSxDQUFDO2FBQ0wsSUFBSSxDQUFDLE9BQU8sRUFBRSxLQUFLLFFBQVEsQ0FBQyxDQUFDLENBQUMsRUFBRSxDQUFDLENBQUMsQ0FBQyxJQUFJLENBQUMsQ0FDeEM7SUFDSCxDQUFDO0NBQ0Q7QUExTUQsOEJBME1DO0FBRUQsa0JBQWUsU0FBUyxDQUFBIiwic291cmNlc0NvbnRlbnQiOlsiLyoqXG4gKiBDcmVhdGVkIGJ5IHVzZXIgb24gMjAxOC80LzE1LzAxNS5cbiAqL1xuaW1wb3J0IHsgSVdvcmQgfSBmcm9tICcuLi9zZWdtZW50L3R5cGVzJztcbmltcG9ydCB7IElEaWN0Um93LCBzZXJpYWxpemUsIHN0cmluZ2lmeUxpbmUgfSBmcm9tICdzZWdtZW50LWRpY3QvbGliL2xvYWRlci9zZWdtZW50JztcbmltcG9ydCBDamtDb252IGZyb20gJ2Nqay1jb252JztcbmltcG9ydCB7IHRleHRfbGlzdCB9IGZyb20gJy4uL3V0aWwvY2prJztcbmltcG9ydCBBYnN0cmFjdFRhYmxlRGljdENvcmUsIHsgSURJQ1QsIElESUNUMiwgSU9wdGlvbnMgfSBmcm9tICcuL2NvcmUnO1xuaW1wb3J0IHsgY2xvbmVEZWVwIH0gZnJvbSAnLi4vdXRpbCc7XG5cbmRlY2xhcmUgZnVuY3Rpb24gX2Nsb25lRGVlcDxUPihkYXRhOiBUKTogVFxuXG5leHBvcnQgdHlwZSBJVGFibGVEaWN0Um93ID0ge1xuXHRwOiBudW1iZXIsXG5cdGY6IG51bWJlcixcblx0cz86IGJvb2xlYW4sXG59O1xuXG5leHBvcnQgeyBJRElDVCwgSURJQ1QyLCBJT3B0aW9ucyB9XG5cbi8qKlxuICogQHRvZG8g5o6b5o6l5YW25LuWIGRpY3RcbiAqL1xuZXhwb3J0IGNsYXNzIFRhYmxlRGljdCBleHRlbmRzIEFic3RyYWN0VGFibGVEaWN0Q29yZTxJVGFibGVEaWN0Um93Plxue1xuXHRwdWJsaWMgdHlwZTogc3RyaW5nO1xuXG5cdFRBQkxFOiBJRElDVDxJVGFibGVEaWN0Um93PiA9IHt9O1xuXHRUQUJMRTI6IElESUNUMjxJVGFibGVEaWN0Um93PiA9IHt9O1xuXG5cdG9wdGlvbnM6IElPcHRpb25zO1xuXG5cdGV4aXN0cyhkYXRhOiBJV29yZCB8IElEaWN0Um93IHwgc3RyaW5nKTogSVRhYmxlRGljdFJvd1xuXHR7XG5cdFx0bGV0IHcsIHAsIGY7XG5cblx0XHRpZiAodHlwZW9mIGRhdGEgPT0gJ3N0cmluZycpXG5cdFx0e1xuXHRcdFx0dyA9IGRhdGE7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpXG5cdFx0e1xuXHRcdFx0W3csIHAsIGZdID0gZGF0YTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdCh7IHcsIHAsIGYgfSA9IGRhdGEpO1xuXHRcdH1cblxuXHRcdHJldHVybiB0aGlzLlRBQkxFW3ddIHx8IG51bGw7XG5cdH1cblxuXHRwcm90ZWN0ZWQgX19oYW5kbGVJbnB1dChkYXRhOiBJV29yZCB8IElEaWN0Um93IHwgc3RyaW5nKVxuXHR7XG5cdFx0bGV0IHc6IHN0cmluZywgcDogbnVtYmVyLCBmOiBudW1iZXI7XG5cdFx0bGV0IHBsdXM6IEFycmF5PHN0cmluZyB8IG51bWJlcj47XG5cblx0XHRpZiAodHlwZW9mIGRhdGEgPT0gJ3N0cmluZycpXG5cdFx0e1xuXHRcdFx0dyA9IGRhdGE7XG5cdFx0fVxuXHRcdGVsc2UgaWYgKEFycmF5LmlzQXJyYXkoZGF0YSkpXG5cdFx0e1xuXHRcdFx0W3csIHAsIGYsIC4uLnBsdXNdID0gZGF0YTtcblx0XHR9XG5cdFx0ZWxzZVxuXHRcdHtcblx0XHRcdCh7IHcsIHAsIGYgfSA9IGRhdGEpO1xuXHRcdH1cblxuXHRcdGlmICh0eXBlb2YgdyAhPT0gJ3N0cmluZycgfHwgdyA9PT0gJycpXG5cdFx0e1xuXHRcdFx0dGhyb3cgbmV3IFR5cGVFcnJvcihKU09OLnN0cmluZ2lmeShkYXRhKSk7XG5cdFx0fVxuXG5cdFx0cCA9ICh0eXBlb2YgcCAhPSAnbnVtYmVyJyB8fCBOdW1iZXIuaXNOYU4ocCkpID8gMCA6IHA7XG5cdFx0ZiA9ICh0eXBlb2YgZiAhPSAnbnVtYmVyJyB8fCBOdW1iZXIuaXNOYU4oZikpID8gMCA6IGY7XG5cblx0XHRyZXR1cm4ge1xuXHRcdFx0ZGF0YToge1xuXHRcdFx0XHR3LCBwLCBmLFxuXHRcdFx0fSxcblx0XHRcdHBsdXMsXG5cdFx0fVxuXHR9XG5cblx0YWRkKGRhdGE6IElXb3JkIHwgSURpY3RSb3cgfCBzdHJpbmcsIHNraXBFeGlzdHM/OiBib29sZWFuKVxuXHR7XG5cdFx0bGV0IHc6IHN0cmluZywgcDogbnVtYmVyLCBmOiBudW1iZXI7XG5cdFx0bGV0IHBsdXM6IEFycmF5PHN0cmluZyB8IG51bWJlcj47XG5cblx0XHR7XG5cdFx0XHRsZXQgcmV0ID0gdGhpcy5fX2hhbmRsZUlucHV0KGRhdGEpO1xuXG5cdFx0XHQoeyB3LCBwLCBmIH0gPSByZXQuZGF0YSk7XG5cdFx0XHRwbHVzID0gcmV0LnBsdXM7XG5cdFx0fVxuXG5cdFx0aWYgKHNraXBFeGlzdHMgJiYgdGhpcy5leGlzdHModykpXG5cdFx0e1xuXHRcdFx0cmV0dXJuIHRoaXM7XG5cdFx0fVxuXG5cdFx0aWYgKHBsdXMgJiYgcGx1cy5sZW5ndGgpXG5cdFx0e1xuXHRcdFx0Ly8gQHRvZG8gZG8gc29tZXRoaW5nXG5cdFx0fVxuXG5cdFx0dGhpcy5fYWRkKHsgdywgcCwgZiwgczogdHJ1ZSB9KTtcblxuXHRcdGxldCBzZWxmID0gdGhpcztcblxuXHRcdC8qKlxuXHRcdCAqIEB0b2RvIOmcgOimgeabtOiBsOaYjueahOS9nOazlSDnm67liY3nmoTlgZrms5Xlr6blnKjlpKrooKJcblx0XHQgKiBAQlVHIOWcqOS4jeaYjuWOn+WboOS4iyDkvLzkuY7kuI3mnIPmraPnorrnmoTmt7vliqDmr4/lgIvpoIXnm64g5aaC5p6c6YGH5Yiw6YCZ56iu5oOF5b2i6KuL5omL5YuV5re75Yqg57Ch57mB6aCF55uuXG5cdFx0ICovXG5cdFx0aWYgKDEgJiYgdGhpcy5vcHRpb25zLmF1dG9DamspXG5cdFx0e1xuXHRcdFx0bGV0IHdhID0gdGV4dF9saXN0KHcpO1xuXG5cdFx0XHR3YS5mb3JFYWNoKGZ1bmN0aW9uICh3Milcblx0XHRcdHtcblx0XHRcdFx0aWYgKHcyICE9IHcgJiYgIXNlbGYuZXhpc3RzKHcyKSlcblx0XHRcdFx0e1xuXHRcdFx0XHRcdHNlbGYuX2FkZCh7IHc6IHcyLCBwLCBmIH0pO1xuXHRcdFx0XHR9XG5cdFx0XHR9KTtcblxuXHRcdFx0Lypcblx0XHRcdGxldCB3Mjogc3RyaW5nO1xuXHRcdFx0dzIgPSBDamtDb252LnpoMmpwKHcpO1xuXG5cdFx0XHRpZiAodzIgIT0gdyAmJiAhdGhpcy5leGlzdHModzIpKVxuXHRcdFx0e1xuXHRcdFx0XHR0aGlzLl9hZGQoe3c6IHcyLCBwLCBmfSk7XG5cdFx0XHRcdC8vY29uc29sZS5sb2codzIpO1xuXHRcdFx0fVxuXG5cdFx0XHR3MiA9IENqa0NvbnYuY2prMnpodCh3KTtcblxuXHRcdFx0aWYgKHcyICE9PSB3ICYmICF0aGlzLmV4aXN0cyh3MikpXG5cdFx0XHR7XG5cdFx0XHRcdHRoaXMuX2FkZCh7dzogdzIsIHAsIGZ9KTtcblx0XHRcdFx0Ly9jb25zb2xlLmxvZyh3Mik7XG5cdFx0XHR9XG5cblx0XHRcdHcyID0gQ2prQ29udi5jamsyemhzKHcpO1xuXG5cdFx0XHRpZiAodzIgIT09IHcgJiYgIXRoaXMuZXhpc3RzKHcyKSlcblx0XHRcdHtcblx0XHRcdFx0dGhpcy5fYWRkKHt3OiB3MiwgcCwgZn0pO1xuXHRcdFx0XHQvL2NvbnNvbGUubG9nKHcyKTtcblx0XHRcdH1cblx0XHRcdCovXG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXM7XG5cdH1cblxuXHRwcm90ZWN0ZWQgX2FkZCh7IHcsIHAsIGYsIHMgfToge1xuXHRcdHc6IHN0cmluZyxcblx0XHRwOiBudW1iZXIsXG5cdFx0ZjogbnVtYmVyLFxuXHRcdHM/OiBib29sZWFuLFxuXHR9KVxuXHR7XG5cdFx0bGV0IGxlbiA9IHcubGVuZ3RoO1xuXG5cdFx0dGhpcy5UQUJMRVt3XSA9IHtcblx0XHRcdHAsXG5cdFx0XHRmLFxuXHRcdFx0cyxcblx0XHR9IGFzIElUYWJsZURpY3RSb3c7XG5cblx0XHRpZiAoIXRoaXMuVEFCTEUyW2xlbl0pIHRoaXMuVEFCTEUyW2xlbl0gPSB7fTtcblxuXHRcdHRoaXMuVEFCTEUyW2xlbl1bd10gPSB0aGlzLlRBQkxFW3ddO1xuXHR9XG5cblx0cmVtb3ZlKHRhcmdldDogSVdvcmQgfCBJRGljdFJvdyB8IHN0cmluZylcblx0e1xuXHRcdGxldCB7IGRhdGEsIHBsdXMgfSA9IHRoaXMuX19oYW5kbGVJbnB1dCh0YXJnZXQpO1xuXG5cdFx0dGhpcy5fcmVtb3ZlKGRhdGEpO1xuXG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdHByb3RlY3RlZCBfcmVtb3ZlKHsgdywgcCwgZiwgcyB9OiBJV29yZClcblx0e1xuXHRcdGxldCBsZW4gPSB3Lmxlbmd0aDtcblxuXHRcdGRlbGV0ZSB0aGlzLlRBQkxFW3ddO1xuXHRcdGlmICh0aGlzLlRBQkxFMltsZW5dKVxuXHRcdHtcblx0XHRcdGRlbGV0ZSB0aGlzLlRBQkxFMltsZW5dW3ddXG5cdFx0fVxuXG5cdFx0cmV0dXJuIHRoaXNcblx0fVxuXG5cdGpzb24oKTogSURJQ1Q8SVRhYmxlRGljdFJvdz5cblx0e1xuXHRcdHJldHVybiBjbG9uZURlZXAodGhpcy5UQUJMRSlcblx0fVxuXG5cdC8qKlxuXHQgKiDlsIfnm67liY3nmoQg6KGo5qC8IOWMr+WHulxuXHQgKi9cblx0c3RyaW5naWZ5KExGID0gXCJcXG5cIilcblx0e1xuXHRcdGxldCBzZWxmID0gdGhpcztcblxuXHRcdHJldHVybiBPYmplY3QuZW50cmllcyhzZWxmLlRBQkxFKVxuXHRcdFx0LnJlZHVjZShmdW5jdGlvbiAoYSwgW3csIHsgcCwgZiB9XSlcblx0XHRcdHtcblx0XHRcdFx0bGV0IGxpbmUgPSBzdHJpbmdpZnlMaW5lKFt3LCBwLCBmXSk7XG5cblx0XHRcdFx0YS5wdXNoKGxpbmUpO1xuXG5cdFx0XHRcdHJldHVybiBhXG5cdFx0XHR9LCBbXSlcblx0XHRcdC5qb2luKHR5cGVvZiBMRiA9PT0gJ3N0cmluZycgPyBMRiA6IFwiXFxuXCIpXG5cdFx0XHQ7XG5cdH1cbn1cblxuZXhwb3J0IGRlZmF1bHQgVGFibGVEaWN0XG4iXX0=